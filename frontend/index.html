<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Diet Tracker FIT - Premium</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: { 50: '#faf5ff', 100: '#f3e8ff', 500: '#d946ef', 600: '#c026d3', 700: '#a21caf' },
            accent: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8' }
          },
          animation: {
            'fade-in': 'fadeIn 0.6s ease-out',
            'slide-up': 'slideUp 0.7s ease-out',
            'scale-in': 'scaleIn 0.4s ease-out',
            'shake': 'shake 0.5s ease-in-out'
          },
          keyframes: {
            fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
            slideUp: { '0%': { transform: 'translateY(30px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
            scaleIn: { '0%': { transform: 'scale(0.9)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } },
            shake: { '0%, 100%': { transform: 'translateX(0)' }, '25%': { transform: 'translateX(-10px)' }, '75%': { transform: 'translateX(10px)' } }
          }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
    .gradient { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .gradient-premium { background: linear-gradient(135deg, #f093fb 0%, #f5576c 50%, #4facfe 100%); }
    .gradient-gold { background: linear-gradient(135deg, #f7971e 0%, #ffd200 100%); }
    .gradient-success { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
    .gradient-error { background: linear-gradient(135deg, #f12711 0%, #f5af19 100%); }
    .gradient-text { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .glass { backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); }
    .glass-card { background: rgba(255,255,255,0.9); backdrop-filter: blur(20px); }
    .dark .glass-card { background: rgba(30,41,59,0.9); }
    .card-hover { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    .card-hover:hover { transform: translateY(-4px) scale(1.02); box-shadow: 0 20px 40px rgba(0,0,0,0.15); }
    .btn-premium { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    .btn-premium:hover { transform: scale(1.05); box-shadow: 0 15px 30px rgba(102,126,234,0.4); }
    .btn-premium:active { transform: scale(0.98); }
    .btn-premium:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .image-overlay { background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, transparent 100%); }
    .shimmer { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
    .dark .shimmer { background: linear-gradient(90deg, #2d3748 25%, #4a5568 50%, #2d3748 75%); }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    @media (max-width: 640px) { .hide-scroll::-webkit-scrollbar { display: none; } .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; } }
    .floating { animation: float 3s ease-in-out infinite; }
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    .glow { box-shadow: 0 0 20px rgba(102,126,234,0.5), 0 0 40px rgba(118,75,162,0.3); }
    .dark .glow { box-shadow: 0 0 20px rgba(102,126,234,0.3), 0 0 40px rgba(118,75,162,0.2); }
    .loading-spinner { border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 3px solid white; width: 20px; height: 20px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .error-shake { animation: shake 0.5s ease-in-out; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 dark:from-gray-900 dark:via-purple-900/20 dark:to-gray-900 transition-colors duration-500">

  <!-- Navbar Premium -->
  <nav class="sticky top-0 z-50 glass-card shadow-xl border-b border-white/20 dark:border-gray-700/50">
    <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center gap-3">
        <div class="w-12 h-12 gradient-premium rounded-2xl flex items-center justify-center text-2xl shadow-lg floating">ğŸ¥—</div>
        <div class="hidden sm:block animate-fade-in">
          <h1 class="text-xl font-black gradient-text tracking-tight">Diet Tracker FIT</h1>
          <p class="text-xs text-gray-500 dark:text-gray-400 font-medium">âœ¨ 350+ recetas premium</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button onclick="toggleDark()" class="p-2.5 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700 transition-all duration-300 transform hover:rotate-12 text-xl" title="Modo oscuro">ğŸŒ™</button>
        <div id="nav-auth" class="flex gap-2 animate-fade-in">
          <button onclick="showModal('login')" class="px-5 py-2.5 text-sm font-bold text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-xl transition-all">Entrar</button>
          <button onclick="showModal('register')" class="gradient-premium text-white px-5 py-2.5 rounded-xl text-sm font-bold shadow-lg btn-premium">Registrarse</button>
        </div>
        <div id="nav-user" class="hidden flex items-center gap-2">
          <div class="w-9 h-9 gradient rounded-xl flex items-center justify-center text-white font-bold text-sm shadow-lg" id="user-avatar">U</div>
          <span id="user-name" class="text-sm font-bold text-gray-700 dark:text-gray-200 hidden sm:block"></span>
          <button onclick="showModal('edit')" class="gradient text-white px-3 py-2 rounded-xl text-xs font-bold shadow-lg btn-premium">âš™ï¸</button>
          <button onclick="logout()" class="text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 p-2.5 rounded-xl transition-all" title="Cerrar sesiÃ³n">ğŸšª</button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main -->
  <main class="max-w-7xl mx-auto px-4 py-6">
    
    <!-- Welcome Screen -->
    <div id="welcome" class="text-center py-16 animate-fade-in">
      <div class="w-24 h-24 gradient-premium rounded-3xl flex items-center justify-center text-5xl shadow-2xl mx-auto mb-8 floating">ğŸ¯</div>
      <h2 class="text-4xl sm:text-5xl font-black text-gray-900 dark:text-white mb-6 tracking-tight">Transforma tu <span class="gradient-text">alimentaciÃ³n</span></h2>
      <p class="text-lg text-gray-600 dark:text-gray-300 mb-10 max-w-2xl mx-auto leading-relaxed">Planes personalizados con productos de Mercadona y Lidl. 350+ recetas saludables con fotos.</p>
      <div class="flex flex-col sm:flex-row justify-center gap-4">
        <button onclick="showModal('register')" class="gradient-premium text-white px-10 py-4 rounded-2xl font-black text-lg shadow-2xl btn-premium glow">ğŸš€ Comenzar gratis</button>
        <button onclick="showModal('login')" class="bg-white dark:bg-gray-800 text-gray-900 dark:text-white px-10 py-4 rounded-2xl font-bold text-lg border-2 border-gray-200 dark:border-gray-700 hover:border-purple-400 transition-all btn-premium">ğŸ‘¤ Ya tengo cuenta</button>
      </div>
      
      <!-- Features -->
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 max-w-5xl mx-auto mt-16">
        <div class="glass-card p-6 rounded-3xl shadow-xl card-hover border border-white/30 dark:border-gray-700/50">
          <div class="text-4xl mb-4">ğŸ“Š</div>
          <h3 class="font-bold text-lg mb-2 text-gray-900 dark:text-white">Macros calculados</h3>
          <p class="text-sm text-gray-600 dark:text-gray-400">ProteÃ­nas, carbohidratos y grasas equilibrados automÃ¡ticamente.</p>
        </div>
        <div class="glass-card p-6 rounded-3xl shadow-xl card-hover border border-white/30 dark:border-gray-700/50">
          <div class="text-4xl mb-4">ğŸ”„</div>
          <h3 class="font-bold text-lg mb-2 text-gray-900 dark:text-white">Variedad total</h3>
          <p class="text-sm text-gray-600 dark:text-gray-400">Cada dÃ­a menÃºs diferentes. Nunca te aburrirÃ¡s comiendo.</p>
        </div>
        <div class="glass-card p-6 rounded-3xl shadow-xl card-hover border border-white/30 dark:border-gray-700/50">
          <div class="text-4xl mb-4">ğŸ›’</div>
          <h3 class="font-bold text-lg mb-2 text-gray-900 dark:text-white">Lista automÃ¡tica</h3>
          <p class="text-sm text-gray-600 dark:text-gray-400">Generada por supermercado. Copia y compra sin pensar.</p>
        </div>
      </div>
    </div>

    <!-- Dashboard Premium -->
    <div id="dashboard" class="hidden animate-fade-in">
      
      <!-- Stats Cards -->
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="glass-card p-5 rounded-3xl shadow-xl border border-white/30 dark:border-gray-700/50 card-hover group">
          <div class="flex items-center gap-3 mb-3">
            <div class="w-11 h-11 gradient rounded-2xl flex items-center justify-center text-2xl shadow-lg group-hover:scale-110 transition-transform">ğŸ”¥</div>
            <span class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wide">CalorÃ­as/dÃ­a</span>
          </div>
          <p id="dash-cals" class="text-3xl font-black gradient-text">--</p>
          <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">Objetivo diario</p>
        </div>
        <div class="glass-card p-5 rounded-3xl shadow-xl border border-white/30 dark:border-gray-700/50 card-hover group">
          <div class="flex items-center gap-3 mb-3">
            <div class="w-11 h-11 gradient-success rounded-2xl flex items-center justify-center text-2xl shadow-lg group-hover:scale-110 transition-transform">âš–ï¸</div>
            <span class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wide">Peso actual</span>
          </div>
          <p id="dash-weight" class="text-3xl font-black text-green-600 dark:text-green-400">-- kg</p>
          <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">Ãšltimo registro</p>
        </div>
        <div class="glass-card p-5 rounded-3xl shadow-xl border border-white/30 dark:border-gray-700/50 card-hover group">
          <div class="flex items-center gap-3 mb-3">
            <div class="w-11 h-11 gradient-gold rounded-2xl flex items-center justify-center text-2xl shadow-lg group-hover:scale-110 transition-transform">ğŸ“ˆ</div>
            <span class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wide">Progreso</span>
          </div>
          <p id="dash-progress" class="text-3xl font-black text-amber-600 dark:text-amber-400">--%</p>
          <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 mt-2 overflow-hidden">
            <div id="progress-bar" class="gradient-gold h-2.5 rounded-full transition-all duration-700" style="width: 0%"></div>
          </div>
        </div>
        <div class="glass-card p-5 rounded-3xl shadow-xl border border-white/30 dark:border-gray-700/50 card-hover group">
          <div class="flex items-center gap-3 mb-3">
            <div class="w-11 h-11 bg-gradient-to-br from-purple-500 to-pink-600 rounded-2xl flex items-center justify-center text-2xl shadow-lg group-hover:scale-110 transition-transform">ğŸ“…</div>
            <span class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wide">Semana</span>
          </div>
          <p id="dash-week" class="text-3xl font-black text-purple-600 dark:text-purple-400">#<span id="week-number">--</span></p>
          <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">En curso</p>
        </div>
      </div>

      <!-- Weight Chart -->
      <div class="glass-card p-6 rounded-3xl shadow-xl border border-white/30 dark:border-gray-700/50 mb-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-black text-lg text-gray-900 dark:text-white flex items-center gap-2">ğŸ“Š EvoluciÃ³n de peso</h3>
          <span class="text-xs font-bold text-purple-600 dark:text-purple-400 bg-purple-100 dark:bg-purple-900/30 px-3 py-1.5 rounded-full">Ãšltimos 30 dÃ­as</span>
        </div>
        <div class="h-64">
          <canvas id="weightChart"></canvas>
        </div>
      </div>

      <!-- Day Tabs Premium -->
      <div class="mb-6">
        <div class="flex gap-2 overflow-x-auto hide-scroll pb-2" id="day-tabs">
          <button onclick="setDay(1)" class="day-btn active flex-shrink-0 px-5 py-3 rounded-2xl font-black text-sm transition-all duration-300 shadow-lg gradient text-white transform scale-105">Lun</button>
          <button onclick="setDay(2)" class="day-btn flex-shrink-0 px-5 py-3 rounded-2xl font-bold text-sm bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 shadow-md hover:shadow-lg transition-all">Mar</button>
          <button onclick="setDay(3)" class="day-btn flex-shrink-0 px-5 py-3 rounded-2xl font-bold text-sm bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 shadow-md hover:shadow-lg transition-all">MiÃ©</button>
          <button onclick="setDay(4)" class="day-btn flex-shrink-0 px-5 py-3 rounded-2xl font-bold text-sm bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 shadow-md hover:shadow-lg transition-all">Jue</button>
          <button onclick="setDay(5)" class="day-btn flex-shrink-0 px-5 py-3 rounded-2xl font-bold text-sm bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 shadow-md hover:shadow-lg transition-all">Vie</button>
          <button onclick="setDay(6)" class="day-btn flex-shrink-0 px-5 py-3 rounded-2xl font-bold text-sm bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 shadow-md hover:shadow-lg transition-all">SÃ¡b</button>
          <button onclick="setDay(7)" class="day-btn flex-shrink-0 px-5 py-3 rounded-2xl font-bold text-sm bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 shadow-md hover:shadow-lg transition-all">Dom</button>
        </div>
      </div>

      <!-- Meals Container -->
      <div id="meals" class="space-y-4 mb-8"></div>

      <!-- Action Buttons Premium -->
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-8">
        <button onclick="showShopping()" class="gradient-premium text-white px-6 py-4 rounded-2xl font-bold text-sm shadow-xl btn-premium flex items-center justify-center gap-2">ğŸ›’ Lista de compra</button>
        <button onclick="exportPlan()" class="bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 px-6 py-4 rounded-2xl font-bold text-sm border-2 border-gray-200 dark:border-gray-700 shadow-lg hover:shadow-xl transition-all btn-premium flex items-center justify-center gap-2">ğŸ“‹ Exportar plan</button>
        <button onclick="regenerate()" class="bg-gradient-to-r from-orange-400 to-pink-500 text-white px-6 py-4 rounded-2xl font-bold text-sm shadow-xl btn-premium flex items-center justify-center gap-2">ğŸ”„ Regenerar</button>
      </div>

      <!-- Weight Check-in -->
      <div class="glass-card p-6 rounded-3xl shadow-xl border border-white/30 dark:border-gray-700/50">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-10 h-10 gradient-success rounded-2xl flex items-center justify-center text-xl shadow-lg">âš–ï¸</div>
          <div>
            <h3 class="font-black text-lg text-gray-900 dark:text-white">Registro de peso</h3>
            <p class="text-xs text-gray-500 dark:text-gray-400">RegÃ­strate 1 vez por semana</p>
          </div>
        </div>
        <div class="flex gap-3">
          <input type="number" id="weight-in" step="0.1" placeholder="Tu peso actual (kg)" class="flex-1 px-5 py-4 rounded-2xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-bold text-lg focus:border-purple-500 dark:focus:border-purple-400 focus:outline-none transition-all shadow-sm">
          <button onclick="checkin()" class="gradient-success text-white px-8 py-4 rounded-2xl font-bold text-base shadow-xl btn-premium whitespace-nowrap">Registrar</button>
        </div>
      </div>
    </div>
  </main>

  <!-- Modals Premium -->
  <div id="modal-login" class="hidden fixed inset-0 bg-black/60 backdrop-blur-md z-50 flex items-center justify-center p-4 animate-fade-in">
    <div class="glass-card rounded-3xl p-8 max-w-sm w-full shadow-2xl border border-white/20 dark:border-gray-700/50 animate-scale-in">
      <div class="text-center mb-6">
        <div class="w-16 h-16 gradient rounded-2xl flex items-center justify-center text-3xl shadow-xl mx-auto mb-4">ğŸ‘‹</div>
        <h3 class="text-2xl font-black text-gray-900 dark:text-white">Â¡Bienvenido!</h3>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Accede a tu cuenta</p>
      </div>
      <form onsubmit="login(event)" class="space-y-4">
        <div>
          <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-2 uppercase tracking-wide">Usuario</label>
          <input type="text" id="login-user" placeholder="Tu nombre de usuario" required class="w-full px-5 py-4 rounded-2xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-bold placeholder-gray-400 dark:placeholder-gray-500 focus:border-purple-500 dark:focus:border-purple-400 focus:outline-none transition-all shadow-sm">
        </div>
        <button type="submit" id="login-btn" class="w-full gradient-premium text-white py-4 rounded-2xl font-black text-lg shadow-xl btn-premium flex items-center justify-center gap-2">
          <span>Entrar</span>
          <div class="loading-spinner hidden"></div>
        </button>
      </form>
      <button onclick="hideModal('login')" class="mt-4 w-full text-gray-500 dark:text-gray-400 text-sm font-medium py-2 hover:text-gray-700 dark:hover:text-gray-200 transition-all">Cancelar</button>
    </div>
  </div>

  <div id="modal-register" class="hidden fixed inset-0 bg-black/60 backdrop-blur-md z-50 flex items-center justify-center p-4 animate-fade-in">
    <div class="glass-card rounded-3xl p-6 max-w-sm w-full shadow-2xl border border-white/20 dark:border-gray-700/50 animate-scale-in max-h-[90vh] overflow-y-auto">
      <div class="text-center mb-5">
        <div class="w-16 h-16 gradient-premium rounded-2xl flex items-center justify-center text-3xl shadow-xl mx-auto mb-4 floating">ğŸ¯</div>
        <h3 class="text-2xl font-black text-gray-900 dark:text-white">Crea tu cuenta</h3>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Gratis â€¢ Sin tarjeta â€¢ 350+ recetas</p>
      </div>
      <form onsubmit="register(event)" class="space-y-3">
        <input type="text" id="reg-user" placeholder="ğŸ‘¤ Usuario" required class="w-full px-4 py-3.5 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-bold placeholder-gray-400 dark:placeholder-gray-500 focus:border-purple-500 dark:focus:border-purple-400 focus:outline-none transition-all text-sm">
        <div class="grid grid-cols-2 gap-2">
          <input type="number" id="reg-age" placeholder="Edad" required min="16" max="100" class="w-full px-4 py-3.5 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-bold placeholder-gray-400 dark:placeholder-gray-500 focus:border-purple-500 dark:focus:border-purple-400 focus:outline-none transition-all text-sm">
          <select id="reg-gender" required class="w-full px-4 py-3.5 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-bold focus:border-purple-500 dark:focus:border-purple-400 focus:outline-none transition-all text-sm">
            <option value="" class="dark:bg-gray-700">GÃ©nero</option>
            <option value="male" class="dark:bg-gray-700">Hombre</option>
            <option value="female" class="dark:bg-gray-700">Mujer</option>
          </select>
        </div>
        <div class="grid grid-cols-2 gap-2">
          <input type="number" id="reg-height" placeholder="Altura (cm)" required min="100" max="250" class="w-full px-4 py-3.5 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-bold placeholder-gray-400 dark:placeholder-gray-500 focus:border-purple-500 dark:focus:border-purple-400 focus:outline-none transition-all text-sm">
          <input type="number" id="reg-weight" placeholder="Peso (kg)" required min="30" max="300" step="0.1" class="w-full px-4 py-3.5 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-bold placeholder-gray-400 dark:placeholder-gray-500 focus:border-purple-500 dark:focus:border-purple-400 focus:outline-none transition-all text-sm">
        </div>
        <input type="number" id="reg-goal" placeholder="ğŸ¯ Peso objetivo (kg)" required min="30" max="300" step="0.1" class="w-full px-4 py-3.5 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-bold placeholder-gray-400 dark:placeholder-gray-500 focus:border-purple-500 dark:focus:border-purple-400 focus:outline-none transition-all text-sm">
        <select id="reg-type" required class="w-full px-4 py-3.5 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-bold focus:border-purple-500 dark:focus:border-purple-400 focus:outline-none transition-all text-sm">
          <option value="" class="dark:bg-gray-700">ğŸ¯ Objetivo</option>
          <option value="lose" class="dark:bg-gray-700">ğŸ“‰ Perder peso</option>
          <option value="maintain" class="dark:bg-gray-700">âš–ï¸ Mantener</option>
          <option value="gain" class="dark:bg-gray-700">ğŸ’ª Ganar masa</option>
        </select>
        <select id="reg-activity" required class="w-full px-4 py-3.5 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-bold focus:border-purple-500 dark:focus:border-purple-400 focus:outline-none transition-all text-sm">
          <option value="" class="dark:bg-gray-700">ğŸƒ Actividad fÃ­sica</option>
          <option value="sedentary" class="dark:bg-gray-700">Sedentario (poco ejercicio)</option>
          <option value="light" class="dark:bg-gray-700">Ligero (1-3 dÃ­as/semana)</option>
          <option value="moderate" class="dark:bg-gray-700">Moderado (3-5 dÃ­as)</option>
          <option value="active" class="dark:bg-gray-700">Activo (6-7 dÃ­as)</option>
          <option value="very_active" class="dark:bg-gray-700">Muy activo (trabajo fÃ­sico)</option>
        </select>
        <select id="reg-meals" required class="w-full px-4 py-3.5 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-bold focus:border-purple-500 dark:focus:border-purple-400 focus:outline-none transition-all text-sm">
          <option value="" class="dark:bg-gray-700">ğŸ½ï¸ Comidas por dÃ­a</option>
          <option value="3" class="dark:bg-gray-700">3 comidas</option>
          <option value="4" class="dark:bg-gray-700">4 comidas</option>
          <option value="5" class="dark:bg-gray-700">5 comidas</option>
        </select>
        <button type="submit" id="register-btn" class="w-full gradient-premium text-white py-4 rounded-2xl font-black text-lg shadow-xl btn-premium mt-2 flex items-center justify-center gap-2">
          <span>Crear cuenta gratis</span>
          <div class="loading-spinner hidden"></div>
        </button>
      </form>
      <button onclick="hideModal('register')" class="mt-4 w-full text-gray-500 dark:text-gray-400 text-sm font-medium py-2 hover:text-gray-700 dark:hover:text-gray-200 transition-all">Cancelar</button>
    </div>
  </div>

  <div id="modal-edit" class="hidden fixed inset-0 bg-black/60 backdrop-blur-md z-50 flex items-center justify-center p-4 animate-fade-in">
    <div class="glass-card rounded-3xl p-6 max-w-sm w-full shadow-2xl border border-white/20 dark:border-gray-700/50 animate-scale-in max-h-[90vh] overflow-y-auto">
      <div class="text-center mb-5">
        <div class="w-16 h-16 gradient rounded-2xl flex items-center justify-center text-3xl shadow-xl mx-auto mb-4">âš™ï¸</div>
        <h3 class="text-2xl font-black text-gray-900 dark:text-white">Editar perfil</h3>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Actualiza tus datos</p>
      </div>
      <form onsubmit="updateProfile(event)" class="space-y-3">
        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-2 uppercase tracking-wide">Edad</label>
            <input type="number" id="edit-age" required class="w-full px-4 py-3.5 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-bold focus:border-purple-500 dark:focus:border-purple-400 focus:outline-none transition-all text-sm">
          </div>
          <div>
            <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-2 uppercase tracking-wide">GÃ©nero</label>
            <select id="edit-gender" required class="w-full px-4 py-3.5 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-bold focus:border-purple-500 dark:focus:border-purple-400 focus:outline-none transition-all text-sm">
              <option value="male" class="dark:bg-gray-700">Hombre</option>
              <option value="female" class="dark:bg-gray-700">Mujer</option>
            </select>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-2 uppercase tracking-wide">Altura (cm)</label>
            <input type="number" id="edit-height" required class="w-full px-4 py-3.5 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-bold focus:border-purple-500 dark:focus:border-purple-400 focus:outline-none transition-all text-sm">
          </div>
          <div>
            <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-2 uppercase tracking-wide">Peso (kg)</label>
            <input type="number" id="edit-weight" step="0.1" required class="w-full px-4 py-3.5 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-bold focus:border-purple-500 dark:focus:border-purple-400 focus:outline-none transition-all text-sm">
          </div>
        </div>
        <div>
          <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-2 uppercase tracking-wide">Peso objetivo (kg)</label>
          <input type="number" id="edit-goal" step="0.1" required class="w-full px-4 py-3.5 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-bold focus:border-purple-500 dark:focus:border-purple-400 focus:outline-none transition-all text-sm">
        </div>
        <div>
          <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-2 uppercase tracking-wide">Objetivo</label>
          <select id="edit-type" required class="w-full px-4 py-3.5 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-bold focus:border-purple-500 dark:focus:border-purple-400 focus:outline-none transition-all text-sm">
            <option value="lose" class="dark:bg-gray-700">ğŸ“‰ Perder peso</option>
            <option value="maintain" class="dark:bg-gray-700">âš–ï¸ Mantener</option>
            <option value="gain" class="dark:bg-gray-700">ğŸ’ª Ganar masa</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-2 uppercase tracking-wide">Actividad</label>
          <select id="edit-activity" required class="w-full px-4 py-3.5 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-bold focus:border-purple-500 dark:focus:border-purple-400 focus:outline-none transition-all text-sm">
            <option value="sedentary" class="dark:bg-gray-700">Sedentario</option>
            <option value="light" class="dark:bg-gray-700">Ligero</option>
            <option value="moderate" class="dark:bg-gray-700">Moderado</option>
            <option value="active" class="dark:bg-gray-700">Activo</option>
            <option value="very_active" class="dark:bg-gray-700">Muy activo</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-2 uppercase tracking-wide">Comidas/dÃ­a</label>
          <select id="edit-meals" required class="w-full px-4 py-3.5 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-bold focus:border-purple-500 dark:focus:border-purple-400 focus:outline-none transition-all text-sm">
            <option value="3" class="dark:bg-gray-700">3 comidas</option>
            <option value="4" class="dark:bg-gray-700">4 comidas</option>
            <option value="5" class="dark:bg-gray-700">5 comidas</option>
          </select>
        </div>
        <button type="submit" id="edit-btn" class="w-full gradient-premium text-white py-4 rounded-2xl font-black text-lg shadow-xl btn-premium mt-3 flex items-center justify-center gap-2">
          <span>ğŸ’¾ Guardar cambios</span>
          <div class="loading-spinner hidden"></div>
        </button>
      </form>
      <button onclick="hideModal('edit')" class="mt-4 w-full text-gray-500 dark:text-gray-400 text-sm font-medium py-2 hover:text-gray-700 dark:hover:text-gray-200 transition-all">Cancelar</button>
    </div>
  </div>

  <div id="modal-options" class="hidden fixed inset-0 bg-black/60 backdrop-blur-md z-50 flex items-center justify-center p-4 animate-fade-in">
    <div class="glass-card rounded-3xl p-6 max-w-lg w-full shadow-2xl border border-white/20 dark:border-gray-700/50 animate-scale-in max-h-[90vh] overflow-y-auto">
      <div class="text-center mb-5">
        <div class="w-16 h-16 gradient rounded-2xl flex items-center justify-center text-3xl shadow-xl mx-auto mb-4">ğŸ”„</div>
        <h3 class="text-2xl font-black text-gray-900 dark:text-white">Cambiar receta</h3>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Selecciona una alternativa</p>
      </div>
      <div id="options-content" class="space-y-4"></div>
      <button onclick="hideModal('options')" class="mt-6 w-full bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 py-4 rounded-2xl font-bold hover:bg-gray-200 dark:hover:bg-gray-600 transition-all">Cerrar</button>
    </div>
  </div>

  <div id="modal-shopping" class="hidden fixed inset-0 bg-black/60 backdrop-blur-md z-50 flex items-center justify-center p-4 animate-fade-in">
    <div class="glass-card rounded-3xl p-6 max-w-lg w-full shadow-2xl border border-white/20 dark:border-gray-700/50 animate-scale-in max-h-[90vh] overflow-y-auto">
      <div class="text-center mb-5">
        <div class="w-16 h-16 gradient-premium rounded-2xl flex items-center justify-center text-3xl shadow-xl mx-auto mb-4">ğŸ›’</div>
        <h3 class="text-2xl font-black text-gray-900 dark:text-white">Lista de compra</h3>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Productos organizados</p>
      </div>
      <div id="shopping-content" class="space-y-4"></div>
      <button onclick="hideModal('shopping')" class="mt-6 w-full bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 py-4 rounded-2xl font-bold hover:bg-gray-200 dark:hover:bg-gray-600 transition-all">Cerrar</button>
    </div>
  </div>

  <script>
    const API = 'https://diet-tracker-app-ten.vercel.app/api';
    let user = null, day = 1, cals = 0, weightChart = null, currentMealType = '';

    // Dark mode - FIXED
    function toggleDark() {
      const html = document.documentElement;
      const isDark = html.classList.toggle('dark');
      localStorage.setItem('dark', isDark);
      // Update chart if exists
      if (weightChart) {
        weightChart.options.scales.y.grid.color = isDark ? '#334155' : '#e2e8f0';
        weightChart.options.scales.y.ticks.color = isDark ? '#94a3b8' : '#64748b';
        weightChart.options.scales.x.ticks.color = isDark ? '#94a3b8' : '#64748b';
        weightChart.update();
      }
    }
    // Initialize dark mode on load
    if (localStorage.getItem('dark') === 'true') {
      document.documentElement.classList.add('dark');
    }

    // Modals with animation
    function showModal(id) { 
      const modal = document.getElementById('modal-'+id);
      modal.classList.remove('hidden');
      // Focus first input
      setTimeout(() => {
        const firstInput = modal.querySelector('input, select');
        if (firstInput) firstInput.focus();
      }, 100);
    }
    function hideModal(id) { 
      document.getElementById('modal-'+id).classList.add('hidden');
      // Clear any error states
      const form = document.getElementById('modal-'+id).querySelector('form');
      if (form) form.classList.remove('error-shake');
    }

    // Show error on form
    function showFormError(modalId, message) {
      const modal = document.getElementById('modal-'+modalId);
      const form = modal.querySelector('form');
      form.classList.add('error-shake');
      setTimeout(() => form.classList.remove('error-shake'), 500);
      alert('âš ï¸ ' + message);
    }

    // Set button loading state
    function setButtonLoading(btnId, loading) {
      const btn = document.getElementById(btnId);
      if (!btn) return;
      const spinner = btn.querySelector('.loading-spinner');
      const text = btn.querySelector('span');
      if (loading) {
        btn.disabled = true;
        if (spinner) spinner.classList.remove('hidden');
        if (text) text.textContent = 'Cargando...';
      } else {
        btn.disabled = false;
        if (spinner) spinner.classList.add('hidden');
        if (text && btnId === 'login-btn') text.textContent = 'Entrar';
        if (text && btnId === 'register-btn') text.textContent = 'Crear cuenta gratis';
        if (text && btnId === 'edit-btn') text.textContent = 'ğŸ’¾ Guardar cambios';
      }
    }

    // Auth - Login
    async function login(e) {
      e.preventDefault();
      const username = document.getElementById('login-user').value.trim();
      if (!username) { showFormError('login', 'Introduce tu usuario'); return; }
      
      setButtonLoading('login-btn', true);
      
      try {
        const r = await fetch(`${API}/login`, { 
          method: 'POST', 
          headers: {'Content-Type': 'application/json'}, 
          body: JSON.stringify({username}) 
        });
        const d = await r.json();
        
        if (d.success) { 
          user = d.user; 
          localStorage.setItem('user', JSON.stringify(user)); 
          document.getElementById('user-avatar').textContent = user.username.charAt(0).toUpperCase(); 
          hideModal('login'); 
          loadDash(); 
        } else { 
          showFormError('login', d.error || 'Usuario no encontrado');
        }
      } catch (err) { 
        showFormError('login', 'Error de conexiÃ³n: ' + err.message); 
      } finally {
        setButtonLoading('login-btn', false);
      }
    }

    // Auth - Register
    async function register(e) {
      e.preventDefault();
      
      const data = {
        username: document.getElementById('reg-user').value.trim(),
        age: parseInt(document.getElementById('reg-age').value),
        gender: document.getElementById('reg-gender').value,
        height: parseFloat(document.getElementById('reg-height').value),
        current_weight: parseFloat(document.getElementById('reg-weight').value),
        goal_weight: parseFloat(document.getElementById('reg-goal').value),
        goal_type: document.getElementById('reg-type').value,
        activity_level: document.getElementById('reg-activity').value,
        meals_per_day: parseInt(document.getElementById('reg-meals').value)
      };
      
      // Validate
      if (!data.username || data.username.length < 3) { showFormError('register', 'Usuario debe tener 3+ caracteres'); return; }
      if (!data.age || data.age < 16 || data.age > 100) { showFormError('register', 'Edad invÃ¡lida (16-100)'); return; }
      if (!data.height || data.height < 100 || data.height > 250) { showFormError('register', 'Altura invÃ¡lida (100-250 cm)'); return; }
      if (!data.current_weight || data.current_weight < 30) { showFormError('register', 'Peso actual invÃ¡lido'); return; }
      if (!data.goal_weight || data.goal_weight < 30) { showFormError('register', 'Peso objetivo invÃ¡lido'); return; }
      if (!data.goal_type) { showFormError('register', 'Selecciona un objetivo'); return; }
      if (!data.activity_level) { showFormError('register', 'Selecciona actividad fÃ­sica'); return; }
      if (!data.meals_per_day) { showFormError('register', 'Selecciona comidas por dÃ­a'); return; }
      
      setButtonLoading('register-btn', true);
      
      try {
        const r = await fetch(`${API}/register`, { 
          method: 'POST', 
          headers: {'Content-Type': 'application/json'}, 
          body: JSON.stringify(data) 
        });
        const d = await r.json();
        
        if (d.success) { 
          user = d.user; 
          localStorage.setItem('user', JSON.stringify(user)); 
          document.getElementById('user-avatar').textContent = user.username.charAt(0).toUpperCase(); 
          alert(`âœ… Â¡Cuenta creada!\n\nğŸ”¥ ${d.target_calories} kcal/dÃ­a\n\nÂ¡Tu plan estÃ¡ listo!`); 
          hideModal('register'); 
          loadDash(); 
        } else { 
          showFormError('register', d.error || 'Error al crear cuenta');
        }
      } catch (err) { 
        showFormError('register', 'Error de conexiÃ³n: ' + err.message); 
      } finally {
        setButtonLoading('register-btn', false);
      }
    }

    // Logout
    function logout() { 
      localStorage.removeItem('user'); 
      user = null; 
      document.getElementById('nav-auth').classList.remove('hidden'); 
      document.getElementById('nav-user').classList.add('hidden'); 
      document.getElementById('welcome').classList.remove('hidden'); 
      document.getElementById('dashboard').classList.add('hidden'); 
      if (weightChart) { weightChart.destroy(); weightChart = null; }
    }

    // Load Dashboard
    async function loadDash() {
      document.getElementById('welcome').classList.add('hidden');
      document.getElementById('dashboard').classList.remove('hidden');
      document.getElementById('nav-auth').classList.add('hidden');
      document.getElementById('nav-user').classList.remove('hidden');
      document.getElementById('user-name').textContent = user.username;
      document.getElementById('user-avatar').textContent = user.username.charAt(0).toUpperCase();
      
      try {
        const [planR, profR] = await Promise.all([
          fetch(`${API}/plan/current?user_id=${user.id}`),
          fetch(`${API}/profile/get?user_id=${user.id}`)
        ]);
        const planD = await planR.json();
        const profD = await profR.json();
        
        if (profD.profile) {
          cals = profD.profile.target_calories || 2000;
          document.getElementById('dash-cals').textContent = `${cals} kcal`;
          document.getElementById('dash-weight').textContent = `${profD.profile.current_weight_kg} kg`;
          const start = profD.profile.starting_weight_kg || profD.profile.current_weight_kg;
          const goal = profD.profile.goal_weight_kg;
          const prog = start > goal ? Math.round(((start - profD.profile.current_weight_kg) / (start - goal)) * 100) : Math.round(((profD.profile.current_weight_kg - start) / (goal - start)) * 100);
          const progClamped = Math.max(0, Math.min(100, prog));
          document.getElementById('dash-progress').textContent = `${progClamped}%`;
          document.getElementById('progress-bar').style.width = `${progClamped}%`;
          document.getElementById('dash-week').innerHTML = `#<span id="week-number">${Math.floor(Math.abs(start - profD.profile.current_weight_kg) / 0.5) + 1}</span>`;
        }
        
        if (planD.plan?.length) { setDay(1); renderDay(1); }
        
        // Load weight chart
        loadWeightChart();
      } catch (err) { 
        console.error('Error loading dashboard:', err);
        alert('âš ï¸ Error al cargar datos: ' + err.message);
      }
    }

    // Set Day
    function setDay(d) {
      day = d;
      document.querySelectorAll('.day-btn').forEach((b, i) => {
        if (i + 1 === d) { 
          b.classList.add('gradient', 'text-white', 'shadow-lg', 'transform', 'scale-105'); 
          b.classList.remove('bg-white', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300', 'shadow-md'); 
        } else { 
          b.classList.remove('gradient', 'text-white', 'shadow-lg', 'transform', 'scale-105'); 
          b.classList.add('bg-white', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300', 'shadow-md'); 
        }
      });
    }

    // Render Day Meals
    async function renderDay(d) {
      try {
        const r = await fetch(`${API}/plan/current?user_id=${user.id}`);
        const data = await r.json();
        const meals = (data.plan || []).filter(m => m.day_of_week === d);
        const container = document.getElementById('meals');
        
        if (!meals.length) { 
          container.innerHTML = '<div class="text-center py-12 glass-card rounded-3xl shadow-xl animate-fade-in"><div class="text-5xl mb-4">ğŸ“­</div><p class="text-gray-500 dark:text-gray-400 font-medium">Sin plan este dÃ­a</p></div>'; 
          return; 
        }
        
        const icons = { 
          desayuno: ['ğŸŒ…', 'Desayuno', 'from-orange-400 to-pink-500'], 
          almuerzo: ['ğŸ', 'Almuerzo', 'from-green-400 to-emerald-500'], 
          comida: ['ğŸ½ï¸', 'Comida', 'from-purple-400 to-pink-500'], 
          merienda: ['ğŸª', 'Merienda', 'from-amber-400 to-orange-500'], 
          cena: ['ğŸŒ™', 'Cena', 'from-indigo-400 to-purple-500'] 
        };
        
        container.innerHTML = meals.map((m, idx) => {
          const icon = icons[m.meal_type] || ['ğŸ½ï¸', 'Comida', 'from-purple-400 to-pink-500'];
          return `
          <div class="glass-card rounded-3xl p-0 shadow-xl border border-white/30 dark:border-gray-700/50 card-hover overflow-hidden animate-slide-up" style="animation-delay: ${idx * 0.1}s">
            <div class="relative">
              ${m.image_url ? `<img src="${m.image_url}" alt="${m.recipe_name}" class="w-full h-48 sm:h-56 object-cover" loading="lazy" onerror="this.parentElement.innerHTML='<div class=\\'w-full h-48 sm:h-56 gradient flex items-center justify-center text-6xl\\'>ğŸ½ï¸</div>'">` : '<div class="w-full h-48 sm:h-56 gradient flex items-center justify-center text-6xl">ğŸ½ï¸</div>'}
              <div class="absolute inset-0 image-overlay"></div>
              <div class="absolute bottom-3 left-3 right-3 flex justify-between items-end">
                <div class="flex items-center gap-2">
                  <span class="text-2xl">${icon[0]}</span>
                  <span class="bg-white/95 dark:bg-gray-800/95 backdrop-blur-sm text-gray-900 dark:text-white text-xs font-black px-3 py-1.5 rounded-full shadow-lg">${icon[1]}</span>
                </div>
                <span class="gradient text-white px-4 py-2 rounded-xl text-sm font-black shadow-lg">${m.calories || 0} kcal</span>
              </div>
            </div>
            <div class="p-5">
              <h4 class="font-black text-xl text-gray-900 dark:text-white mb-3 leading-tight">${m.recipe_name || 'Sin nombre'}</h4>
              <p class="text-sm text-gray-600 dark:text-gray-300 mb-4 leading-relaxed">${m.ingredients || 'Sin ingredientes'}</p>
              <div class="flex flex-wrap gap-2 mb-4">
                <span class="bg-blue-500 text-white px-3 py-1.5 rounded-xl text-xs font-bold shadow-md">ğŸ¥© ${Math.round(m.protein || 0)}g prot</span>
                <span class="bg-yellow-500 text-white px-3 py-1.5 rounded-xl text-xs font-bold shadow-md">ğŸ ${Math.round(m.carbs || 0)}g carb</span>
                <span class="bg-purple-500 text-white px-3 py-1.5 rounded-xl text-xs font-bold shadow-md">ğŸ¥‘ ${Math.round(m.fat || 0)}g grasa</span>
              </div>
              <button onclick="showOptions('${m.meal_type}')" class="w-full gradient-premium text-white py-3.5 rounded-2xl font-bold text-sm shadow-lg btn-premium flex items-center justify-center gap-2">ğŸ”„ Cambiar receta</button>
            </div>
          </div>`;
        }).join('');
      } catch (err) { 
        document.getElementById('meals').innerHTML = `<div class="text-center py-12 glass-card rounded-3xl shadow-xl"><div class="text-5xl mb-4">âŒ</div><p class="text-red-500 font-bold">Error: ${err.message}</p></div>`; 
      }
    }

    // Weight Check-in
    async function checkin() {
      const w = parseFloat(document.getElementById('weight-in').value);
      if (!w || w <= 0) return alert('âš ï¸ Peso invÃ¡lido');
      try {
        const r = await fetch(`${API}/weight/checkin`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({user_id: user.id, weight: w}) });
        const d = await r.json();
        if (d.success) { 
          alert(`âœ… Â¡Peso registrado!\n\nğŸ“Š Nuevo peso: ${w} kg\n${d.new_recipes ? 'ğŸ‰ Â¡Nuevas recetas desbloqueadas!' : ''}`); 
          document.getElementById('weight-in').value = ''; 
          loadDash(); 
        } else alert('âš ï¸ ' + (d.error || 'Error'));
      } catch (err) { alert('âŒ Error: ' + err.message); }
    }

    // Show Options Modal
    async function showOptions(mealType) {
      currentMealType = mealType;
      try {
        const r = await fetch(`${API}/food-bank/options?user_id=${user.id}&meal_type=${mealType}`);
        const d = await r.json();
        const content = document.getElementById('options-content');
        if (!d.options?.length) { 
          content.innerHTML = '<div class="text-center py-12"><div class="text-5xl mb-4">ğŸ“­</div><p class="text-gray-500 dark:text-gray-400 font-medium">Sin opciones disponibles</p></div>'; 
        } else {
          content.innerHTML = d.options.map((o, idx) => `
            <div class="glass-card border border-white/30 dark:border-gray-700/50 rounded-2xl p-4 card-hover animate-slide-up" style="animation-delay: ${idx * 0.05}s">
              <div class="flex gap-4">
                ${o.image_url ? `<img src="${o.image_url}" class="w-24 h-24 object-cover rounded-xl shadow-md flex-shrink-0" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23667eea%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2255%22 font-size=%2240%22 text-anchor=%22middle%22>ğŸ½ï¸</text></svg>'">` : '<div class="w-24 h-24 gradient rounded-xl flex items-center justify-center text-3xl flex-shrink-0">ğŸ½ï¸</div>'}
                <div class="flex-1 min-w-0">
                  <h4 class="font-bold text-gray-900 dark:text-white mb-1 truncate">${o.name}</h4>
                  <p class="text-xs text-gray-600 dark:text-gray-300 mb-2 line-clamp-2">${o.ingredients}</p>
                  <div class="flex flex-wrap gap-1.5">
                    <span class="gradient text-white px-2 py-1 rounded-lg text-xs font-bold">${o.calories} kcal</span>
                    <span class="bg-blue-500 text-white px-2 py-1 rounded-lg text-xs font-bold">ğŸ¥© ${Math.round(o.protein)}g</span>
                    <span class="bg-yellow-500 text-white px-2 py-1 rounded-lg text-xs font-bold">ğŸ ${Math.round(o.carbs)}g</span>
                    <span class="bg-purple-500 text-white px-2 py-1 rounded-lg text-xs font-bold">ğŸ¥‘ ${Math.round(o.fat)}g</span>
                  </div>
                </div>
                <button onclick="swap(${o.recipe_id})" class="gradient-premium text-white px-5 py-2.5 rounded-xl font-bold text-sm shadow-lg btn-premium h-fit whitespace-nowrap">Elegir</button>
              </div>
            </div>`).join('');
        }
        showModal('options');
      } catch (err) { alert('âŒ Error: ' + err.message); }
    }

    // Swap Recipe
    async function swap(recipeId) {
      try {
        const r = await fetch(`${API}/plan/swap`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({user_id: user.id, day: day, meal_type: currentMealType, new_recipe_id: recipeId}) });
        const d = await r.json();
        if (d.success) { hideModal('options'); renderDay(day); }
        else alert('âš ï¸ ' + (d.error || 'Error'));
      } catch (err) { alert('âŒ Error: ' + err.message); }
    }

    // Show Shopping List
    async function showShopping() {
      try {
        const r = await fetch(`${API}/plan/shopping-list?user_id=${user.id}`);
        const d = await r.json();
        const list = d.list || {};
        let html = '';
        if (list.mercadona?.length) html += `<div class="bg-gradient-to-br from-red-50 to-pink-50 dark:from-red-900/20 dark:to-pink-900/20 border-2 border-red-200 dark:border-red-800 rounded-2xl p-5"><h4 class="font-black text-red-700 dark:text-red-400 mb-3 flex items-center gap-2 text-lg"><span class="text-xl">ğŸ›’</span> Mercadona</h4><ul class="space-y-2 text-sm">${list.mercadona.map(i => `<li class="flex items-start gap-2"><span class="text-green-500 font-bold text-lg">âœ“</span><span class="text-gray-700 dark:text-gray-300">${i}</span></li>`).join('')}</ul></div>`;
        if (list.lidl?.length) html += `<div class="bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 border-2 border-blue-200 dark:border-blue-800 rounded-2xl p-5"><h4 class="font-black text-blue-700 dark:text-blue-400 mb-3 flex items-center gap-2 text-lg"><span class="text-xl">ğŸ›’</span> Lidl</h4><ul class="space-y-2 text-sm">${list.lidl.map(i => `<li class="flex items-start gap-2"><span class="text-green-500 font-bold text-lg">âœ“</span><span class="text-gray-700 dark:text-gray-300">${i}</span></li>`).join('')}</ul></div>`;
        if (list.mixto?.length) html += `<div class="bg-gradient-to-br from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20 border-2 border-purple-200 dark:border-purple-800 rounded-2xl p-5"><h4 class="font-black text-purple-700 dark:text-purple-400 mb-3 flex items-center gap-2 text-lg"><span class="text-xl">ğŸ›’</span> Ambos supermercados</h4><ul class="space-y-2 text-sm">${list.mixto.map(i => `<li class="flex items-start gap-2"><span class="text-green-500 font-bold text-lg">âœ“</span><span class="text-gray-700 dark:text-gray-300">${i}</span></li>`).join('')}</ul></div>`;
        document.getElementById('shopping-content').innerHTML = html || '<div class="text-center py-12"><div class="text-5xl mb-4">ğŸ“­</div><p class="text-gray-500 dark:text-gray-400 font-medium">Lista vacÃ­a</p></div>';
        showModal('shopping');
      } catch (err) { alert('âŒ Error: ' + err.message); }
    }

    // Regenerate Plan
    async function regenerate() {
      if (!confirm('âš ï¸ Â¿Regenerar plan semanal?')) return;
      try {
        const r = await fetch(`${API}/plan/regenerate`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({user_id: user.id}) });
        const d = await r.json();
        if (d.success) { alert('âœ… Â¡Plan regenerado!'); renderDay(day); }
        else alert('âš ï¸ ' + (d.error || 'Error'));
      } catch (err) { alert('âŒ Error: ' + err.message); }
    }

    // Export Plan
    async function exportPlan() {
      try {
        const r = await fetch(`${API}/plan/export?user_id=${user.id}`);
        const d = await r.json();
        if (d.export) { await navigator.clipboard.writeText(d.export); alert('âœ… Â¡Plan copiado al portapapeles!'); }
      } catch (err) { alert('âŒ Error: ' + err.message); }
    }

    // Update Profile
    async function updateProfile(e) {
      e.preventDefault();
      const data = {
        user_id: user.id,
        age: parseInt(document.getElementById('edit-age').value),
        gender: document.getElementById('edit-gender').value,
        height: parseFloat(document.getElementById('edit-height').value),
        current_weight: parseFloat(document.getElementById('edit-weight').value),
        goal_weight: parseFloat(document.getElementById('edit-goal').value),
        goal_type: document.getElementById('edit-type').value,
        activity_level: document.getElementById('edit-activity').value,
        meals_per_day: parseInt(document.getElementById('edit-meals').value)
      };
      
      setButtonLoading('edit-btn', true);
      
      try {
        const r = await fetch(`${API}/profile/update`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
        const d = await r.json();
        if (d.success) {
          user = { ...user, ...data };
          localStorage.setItem('user', JSON.stringify(user));
          alert(`âœ… Â¡Perfil actualizado!\n${d.recalculated ? `ğŸ”¥ ${d.target_calories} kcal/dÃ­a` : ''}`);
          hideModal('edit');
          loadDash();
        } else alert('âš ï¸ ' + (d.error || 'Error'));
      } catch (err) { alert('âŒ Error: ' + err.message); }
      finally {
        setButtonLoading('edit-btn', false);
      }
    }

    // Weight Chart
    async function loadWeightChart() {
      try {
        const r = await fetch(`${API}/weight/history?user_id=${user.id}`);
        const d = await r.json();
        const history = d.history || [];
        
        const ctx = document.getElementById('weightChart').getContext('2d');
        
        if (weightChart) weightChart.destroy();
        
        const isDark = document.documentElement.classList.contains('dark');
        
        weightChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: history.map(h => new Date(h.created_at).toLocaleDateString('es-ES', { day: 'numeric', month: 'short' })),
            datasets: [{
              label: 'Peso (kg)',
              data: history.map(h => h.weight),
              borderColor: '#8b5cf6',
              backgroundColor: 'rgba(139, 92, 246, 0.1)',
              borderWidth: 3,
              fill: true,
              tension: 0.4,
              pointBackgroundColor: '#8b5cf6',
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              pointRadius: 5,
              pointHoverRadius: 7
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: isDark ? '#1e293b' : '#fff',
                titleColor: isDark ? '#f1f5f9' : '#0f172a',
                bodyColor: isDark ? '#cbd5e1' : '#475569',
                borderColor: isDark ? '#475569' : '#e2e8f0',
                borderWidth: 1,
                padding: 12,
                displayColors: false,
                callbacks: {
                  label: (ctx) => `${ctx.parsed.y} kg`
                }
              }
            },
            scales: {
              y: {
                beginAtZero: false,
                grid: { color: isDark ? '#334155' : '#e2e8f0' },
                ticks: { color: isDark ? '#94a3b8' : '#64748b' }
              },
              x: {
                grid: { display: false },
                ticks: { color: isDark ? '#94a3b8' : '#64748b' }
              }
            }
          }
        });
      } catch (err) {
        console.error('Error loading chart:', err);
      }
    }

    // Init on load
    window.addEventListener('DOMContentLoaded', () => {
      // Dark mode already initialized above
      const saved = localStorage.getItem('user');
      if (saved) { 
        user = JSON.parse(saved); 
        document.getElementById('user-avatar').textContent = user.username.charAt(0).toUpperCase(); 
        loadDash(); 
      }
    });
  </script>
</body>
</html>
