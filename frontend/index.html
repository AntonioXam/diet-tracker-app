<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Diet Tracker - Tu plan semanal Mercadona/Lidl</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
  
  <!-- Navbar -->
  <nav class="bg-white shadow-sm border-b">
    <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
      <h1 class="text-xl font-bold text-indigo-600">ü•ó Diet Tracker</h1>
      <div id="nav-auth">
        <button onclick="showLogin()" class="text-indigo-600 hover:text-indigo-800 font-medium">Iniciar sesi√≥n</button>
        <span class="mx-2 text-gray-300">|</span>
        <button onclick="showRegister()" class="text-indigo-600 hover:text-indigo-800 font-medium">Registrarse</button>
      </div>
      <div id="nav-user" class="hidden flex items-center gap-4">
        <span id="user-name" class="text-gray-700 font-medium"></span>
        <button onclick="logout()" class="text-red-600 hover:text-red-800 text-sm">Salir</button>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="max-w-6xl mx-auto px-4 py-8">
    
    <!-- Welcome Screen -->
    <div id="welcome-screen" class="text-center py-16">
      <h2 class="text-4xl font-bold text-gray-800 mb-4">Tu dieta personalizada con productos Mercadona y Lidl</h2>
      <p class="text-xl text-gray-600 mb-8">Plan semanal progresivo que se adapta a tu evoluci√≥n</p>
      <div class="flex justify-center gap-4">
        <button onclick="showRegister()" class="bg-indigo-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-indigo-700 transition">Comenzar gratis</button>
        <button onclick="showLogin()" class="bg-white text-indigo-600 px-8 py-3 rounded-lg font-semibold border-2 border-indigo-600 hover:bg-indigo-50 transition">Ya tengo cuenta</button>
      </div>
      
      <div class="mt-16 grid md:grid-cols-3 gap-8 text-left">
        <div class="bg-white p-6 rounded-xl shadow-md">
          <div class="text-3xl mb-3">üìù</div>
          <h3 class="font-bold text-lg mb-2">Cuestionario inicial</h3>
          <p class="text-gray-600">Cu√©ntanos tus datos, objetivos y preferencias para crear tu plan perfecto.</p>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-md">
          <div class="text-3xl mb-3">üîÑ</div>
          <h3 class="font-bold text-lg mb-2">Sistema progresivo</h3>
          <p class="text-gray-600">Cada semana nuevas opciones hasta tener 6 alternativas por comida.</p>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-md">
          <div class="text-3xl mb-3">üõí</div>
          <h3 class="font-bold text-lg mb-2">Lista de la compra</h3>
          <p class="text-gray-600">Generada autom√°ticamente con productos Mercadona y Lidl.</p>
        </div>
      </div>
    </div>

    <!-- Login Form -->
    <div id="login-form" class="hidden max-w-md mx-auto bg-white rounded-xl shadow-lg p-8 fade-in">
      <h2 class="text-2xl font-bold text-center mb-6">Iniciar sesi√≥n</h2>
      <form onsubmit="handleLogin(event)">
        <div class="mb-4">
          <label class="block text-gray-700 font-medium mb-2">Email</label>
          <input type="email" id="login-email" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
        </div>
        <div class="mb-6">
          <label class="block text-gray-700 font-medium mb-2">Contrase√±a</label>
          <input type="password" id="login-password" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
        </div>
        <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition">Entrar</button>
      </form>
      <p class="text-center mt-4 text-gray-600">
        ¬øNo tienes cuenta? <button onclick="showRegister()" class="text-indigo-600 font-medium hover:underline">Reg√≠strate</button>
      </p>
    </div>

    <!-- Register Form -->
    <div id="register-form" class="hidden max-w-md mx-auto bg-white rounded-xl shadow-lg p-8 fade-in">
      <h2 class="text-2xl font-bold text-center mb-6">Crear cuenta</h2>
      <form onsubmit="handleRegister(event)">
        <div class="mb-4">
          <label class="block text-gray-700 font-medium mb-2">Nombre</label>
          <input type="text" id="register-name" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
        </div>
        <div class="mb-4">
          <label class="block text-gray-700 font-medium mb-2">Email</label>
          <input type="email" id="register-email" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
        </div>
        <div class="mb-6">
          <label class="block text-gray-700 font-medium mb-2">Contrase√±a</label>
          <input type="password" id="register-password" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
        </div>
        <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition">Registrarse</button>
      </form>
      <p class="text-center mt-4 text-gray-600">
        ¬øYa tienes cuenta? <button onclick="showLogin()" class="text-indigo-600 font-medium hover:underline">Inicia sesi√≥n</button>
      </p>
    </div>

    <!-- Onboarding Questionnaire -->
    <div id="onboarding-form" class="hidden max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-8 fade-in">
      <h2 class="text-2xl font-bold text-center mb-2">üìã Tu perfil nutricional</h2>
      <p class="text-center text-gray-600 mb-6">Completa estos datos para personalizar tu plan</p>
      
      <form onsubmit="handleOnboarding(event)" class="space-y-6">
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-gray-700 font-medium mb-2">Edad</label>
            <input type="number" id="ob-age" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
          </div>
          <div>
            <label class="block text-gray-700 font-medium mb-2">G√©nero</label>
            <select id="ob-gender" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
              <option value="male">Hombre</option>
              <option value="female">Mujer</option>
            </select>
          </div>
        </div>
        
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-gray-700 font-medium mb-2">Altura (cm)</label>
            <input type="number" id="ob-height" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
          </div>
          <div>
            <label class="block text-gray-700 font-medium mb-2">Peso actual (kg)</label>
            <input type="number" id="ob-current-weight" required step="0.1" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
          </div>
        </div>
        
        <div>
          <label class="block text-gray-700 font-medium mb-2">Peso objetivo (kg)</label>
          <input type="number" id="ob-goal-weight" required step="0.1" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
        </div>
        
        <div>
          <label class="block text-gray-700 font-medium mb-2">Objetivo</label>
          <select id="ob-goal-type" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
            <option value="lose">Perder peso</option>
            <option value="maintain">Mantener peso</option>
            <option value="gain">Ganar m√∫sculo</option>
          </select>
        </div>
        
        <div>
          <label class="block text-gray-700 font-medium mb-2">Nivel de actividad</label>
          <select id="ob-activity" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
            <option value="sedentary">Sedentario (poco o nada de ejercicio)</option>
            <option value="light">Ligero (1-3 d√≠as/semana)</option>
            <option value="moderate">Moderado (3-5 d√≠as/semana)</option>
            <option value="active">Activo (6-7 d√≠as/semana)</option>
            <option value="very_active">Muy activo (trabajo f√≠sico o 2x d√≠a)</option>
          </select>
        </div>
        
        <div>
          <label class="block text-gray-700 font-medium mb-2">Comidas al d√≠a</label>
          <select id="ob-meals" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
            <option value="3">3 comidas</option>
            <option value="4">4 comidas</option>
            <option value="5">5 comidas (recomendado)</option>
          </select>
        </div>
        
        <div>
          <label class="block text-gray-700 font-medium mb-2">Alergias o intolerancias (opcional)</label>
          <input type="text" id="ob-allergies" placeholder="Ej: gluten, lactosa, frutos secos..." class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
        </div>
        
        <div>
          <label class="block text-gray-700 font-medium mb-2">Alimentos que no te gustan (opcional)</label>
          <input type="text" id="ob-disliked" placeholder="Ej: pescado, br√≥coli..." class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
        </div>
        
        <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition">Crear mi plan</button>
      </form>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="hidden fade-in">
      
      <!-- Stats Overview -->
      <div class="grid md:grid-cols-4 gap-4 mb-8">
        <div class="bg-white p-4 rounded-xl shadow-md">
          <p class="text-gray-600 text-sm">Calor√≠as objetivo</p>
          <p id="dash-calories" class="text-2xl font-bold text-indigo-600">--</p>
        </div>
        <div class="bg-white p-4 rounded-xl shadow-md">
          <p class="text-gray-600 text-sm">Peso actual</p>
          <p id="dash-weight" class="text-2xl font-bold text-green-600">-- kg</p>
        </div>
        <div class="bg-white p-4 rounded-xl shadow-md">
          <p class="text-gray-600 text-sm">Progreso</p>
          <p id="dash-progress" class="text-2xl font-bold text-blue-600">--%</p>
        </div>
        <div class="bg-white p-4 rounded-xl shadow-md">
          <p class="text-gray-600 text-sm">Semana</p>
          <p id="dash-week" class="text-2xl font-bold text-purple-600">#<span id="week-number">--</span></p>
        </div>
      </div>
      
      <!-- Weekly Plan -->
      <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold">üìÖ Tu plan semanal</h2>
          <button onclick="loadShoppingList()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition flex items-center gap-2">
            üõí Lista de la compra
          </button>
        </div>
        
        <!-- Day Tabs -->
        <div class="flex flex-wrap gap-2 mb-6" id="day-tabs">
          <button class="day-tab bg-indigo-600 text-white px-4 py-2 rounded-lg font-medium" data-day="1">Lunes</button>
          <button class="day-tab bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium" data-day="2">Martes</button>
          <button class="day-tab bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium" data-day="3">Mi√©rcoles</button>
          <button class="day-tab bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium" data-day="4">Jueves</button>
          <button class="day-tab bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium" data-day="5">Viernes</button>
          <button class="day-tab bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium" data-day="6">S√°bado</button>
          <button class="day-tab bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium" data-day="7">Domingo</button>
        </div>
        
        <!-- Meals Container -->
        <div id="meals-container" class="space-y-4">
          <!-- Se llena din√°micamente -->
        </div>
        
        <!-- Daily Macros -->
        <div class="mt-6 pt-6 border-t">
          <h3 class="font-bold text-lg mb-3">Macros del d√≠a</h3>
          <div class="grid md:grid-cols-4 gap-4" id="daily-macros">
            <div class="text-center">
              <p class="text-2xl font-bold text-indigo-600" id="macro-calories">0</p>
              <p class="text-sm text-gray-600">Calor√≠as</p>
            </div>
            <div class="text-center">
              <p class="text-2xl font-bold text-red-600" id="macro-protein">0g</p>
              <p class="text-sm text-gray-600">Prote√≠nas</p>
            </div>
            <div class="text-center">
              <p class="text-2xl font-bold text-yellow-600" id="macro-carbs">0g</p>
              <p class="text-sm text-gray-600">Carbohidratos</p>
            </div>
            <div class="text-center">
              <p class="text-2xl font-bold text-blue-600" id="macro-fat">0g</p>
              <p class="text-sm text-gray-600">Grasas</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Weight Check-in -->
      <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
        <h2 class="text-2xl font-bold mb-4">‚öñÔ∏è Registro semanal de peso</h2>
        <p class="text-gray-600 mb-4">Introduce tu peso actual para desbloquear la pr√≥xima semana y nuevas opciones.</p>
        <form onsubmit="handleWeightCheckin(event)" class="flex gap-4 items-end">
          <div class="flex-1">
            <label class="block text-gray-700 font-medium mb-2">Peso actual (kg)</label>
            <input type="number" id="checkin-weight" required step="0.1" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
          </div>
          <button type="submit" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition">Registrar</button>
        </form>
      </div>
    </div>

    <!-- Shopping List Modal -->
    <div id="shopping-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
      <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-y-auto">
        <div class="p-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold">üõí Lista de la compra</h2>
            <button onclick="closeShoppingModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
          </div>
          <div id="shopping-content" class="space-y-4">
            <!-- Se llena din√°micamente -->
          </div>
        </div>
      </div>
    </div>

    <!-- Meal Options Modal -->
    <div id="options-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
      <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-y-auto">
        <div class="p-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold">üîÑ Cambiar opci√≥n</h2>
            <button onclick="closeOptionsModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
          </div>
          <div id="options-content" class="space-y-3">
            <!-- Se llena din√°micamente -->
          </div>
        </div>
      </div>
    </div>

  </main>

  <!-- Footer -->
  <footer class="bg-white border-t mt-16">
    <div class="max-w-6xl mx-auto px-4 py-6 text-center text-gray-600">
      <p>ü•ó Diet Tracker - Planes personalizados con productos Mercadona y Lidl</p>
      <p class="text-sm mt-2">Sistema progresivo: cada semana nuevas opciones hasta tener 6 alternativas por comida</p>
    </div>
  </footer>

  <script>
    // ============================================================
    // ESTADO GLOBAL
    // ============================================================
    let currentUser = null;
    let currentPlan = null;
    let selectedDay = 1;
    const API_URL = '/api';

    // ============================================================
    // NAVEGACI√ìN
    // ============================================================
    function hideAll() {
      ['welcome-screen', 'login-form', 'register-form', 'onboarding-form', 'dashboard'].forEach(id => {
        document.getElementById(id).classList.add('hidden');
      });
    }

    function showWelcome() {
      hideAll();
      document.getElementById('welcome-screen').classList.remove('hidden');
      updateNav();
    }

    function showLogin() {
      hideAll();
      document.getElementById('login-form').classList.remove('hidden');
    }

    function showRegister() {
      hideAll();
      document.getElementById('register-form').classList.remove('hidden');
    }

    function showOnboarding() {
      hideAll();
      document.getElementById('onboarding-form').classList.remove('hidden');
    }

    function showDashboard() {
      hideAll();
      document.getElementById('dashboard').classList.remove('hidden');
      updateNav();
      loadDashboard();
    }

    function updateNav() {
      const authDiv = document.getElementById('nav-auth');
      const userDiv = document.getElementById('nav-user');
      
      if (currentUser) {
        authDiv.classList.add('hidden');
        userDiv.classList.remove('hidden');
        document.getElementById('user-name').textContent = currentUser.name;
      } else {
        authDiv.classList.remove('hidden');
        userDiv.classList.add('hidden');
      }
    }

    // ============================================================
    // AUTENTICACI√ìN
    // ============================================================
    async function handleRegister(e) {
      e.preventDefault();
      
      const name = document.getElementById('register-name').value;
      const email = document.getElementById('register-email').value;
      const password = document.getElementById('register-password').value;
      
      try {
        const res = await fetch(`${API_URL}/register`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({name, email, password})
        });
        
        const data = await res.json();
        
        if (data.success) {
          currentUser = {id: data.user_id, name, email};
          localStorage.setItem('user', JSON.stringify(currentUser));
          showOnboarding();
        } else {
          alert(data.error || 'Error al registrar');
        }
      } catch (err) {
        alert('Error de conexi√≥n: ' + err.message);
      }
    }

    async function handleLogin(e) {
      e.preventDefault();
      
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      
      try {
        const res = await fetch(`${API_URL}/login`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({email, password})
        });
        
        const data = await res.json();
        
        if (data.success) {
          currentUser = {id: data.user_id, name: data.name, email};
          localStorage.setItem('user', JSON.stringify(currentUser));
          showDashboard();
        } else {
          alert(data.error || 'Credenciales inv√°lidas');
        }
      } catch (err) {
        alert('Error de conexi√≥n: ' + err.message);
      }
    }

    function logout() {
      currentUser = null;
      localStorage.removeItem('user');
      showWelcome();
    }

    // ============================================================
    // ONBOARDING
    // ============================================================
    async function handleOnboarding(e) {
      e.preventDefault();
      
      const profile = {
        user_id: currentUser.id,
        age: parseInt(document.getElementById('ob-age').value),
        gender: document.getElementById('ob-gender').value,
        height: parseFloat(document.getElementById('ob-height').value),
        current_weight: parseFloat(document.getElementById('ob-current-weight').value),
        goal_weight: parseFloat(document.getElementById('ob-goal-weight').value),
        goal_type: document.getElementById('ob-goal-type').value,
        activity_level: document.getElementById('ob-activity').value,
        meals_per_day: parseInt(document.getElementById('ob-meals').value),
        allergies: document.getElementById('ob-allergies').value,
        disliked_foods: document.getElementById('ob-disliked').value
      };
      
      try {
        const res = await fetch(`${API_URL}/profile`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(profile)
        });
        
        const data = await res.json();
        
        if (data.success) {
          alert(`¬°Plan creado! Tus calor√≠as objetivo: ${data.target_calories} kcal/d√≠a`);
          showDashboard();
        } else {
          alert(data.error || 'Error al crear perfil');
        }
      } catch (err) {
        alert('Error de conexi√≥n: ' + err.message);
      }
    }

    // ============================================================
    // DASHBOARD
    // ============================================================
    async function loadDashboard() {
      if (!currentUser) return;
      
      try {
        // Cargar plan
        const planRes = await fetch(`${API_URL}/plan/current?user_id=${currentUser.id}`);
        currentPlan = await planRes.json();
        
        // Cargar stats
        const statsRes = await fetch(`${API_URL}/stats?user_id=${currentUser.id}`);
        const stats = await statsRes.json();
        
        // Actualizar UI
        document.getElementById('week-number').textContent = currentPlan.week || 1;
        document.getElementById('dash-weight').textContent = `${stats.current_weight || '--'} kg`;
        document.getElementById('dash-progress').textContent = `${stats.progress_percent || 0}%`;
        document.getElementById('dash-calories').textContent = currentPlan.daily_totals?.[selectedDay]?.calories ? 
          `${Math.round(currentPlan.daily_totals[selectedDay].calories)} kcal` : '--';
        
        // Configurar tabs de d√≠as
        document.querySelectorAll('.day-tab').forEach(tab => {
          tab.onclick = () => selectDay(parseInt(tab.dataset.day));
        });
        
        selectDay(1);
        
      } catch (err) {
        console.error('Error loading dashboard:', err);
      }
    }

    function selectDay(day) {
      selectedDay = day;
      
      // Actualizar tabs
      document.querySelectorAll('.day-tab').forEach(tab => {
        const isSelected = parseInt(tab.dataset.day) === day;
        tab.className = `day-tab px-4 py-2 rounded-lg font-medium transition ${
          isSelected ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
        }`;
      });
      
      // Cargar comidas del d√≠a
      loadDayMeals(day);
    }

    function loadDayMeals(day) {
      const container = document.getElementById('meals-container');
      const meals = currentPlan.meals?.filter(m => m.day_of_week === day) || [];
      
      if (meals.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8">No hay comidas para este d√≠a</p>';
        updateMacros({});
        return;
      }
      
      const mealLabels = {
        desayuno: 'üåÖ Desayuno',
        almuerzo: 'üçé Almuerzo',
        comida: 'üçΩ Comida',
        merienda: 'üç™ Merienda',
        cena: 'üåô Cena'
      };
      
      container.innerHTML = meals.map(meal => `
        <div class="border rounded-lg p-4 hover:shadow-md transition">
          <div class="flex justify-between items-start">
            <div class="flex-1">
              <h3 class="font-bold text-indigo-600">${mealLabels[meal.meal_type] || meal.meal_type}</h3>
              <p class="font-semibold text-lg">${meal.recipe_name}</p>
              <p class="text-sm text-gray-600 mt-1">${meal.ingredients}</p>
              <div class="flex gap-4 mt-2 text-sm">
                <span class="text-red-600">üî• ${meal.calories} kcal</span>
                <span class="text-blue-600">ü•© ${Math.round(meal.protein)}g prot</span>
                <span class="text-yellow-600">üçû ${Math.round(meal.carbs)}g carb</span>
                <span class="text-purple-600">ü•ë ${Math.round(meal.fat)}g grasa</span>
              </div>
            </div>
            <button onclick="showOptionsModal('${meal.meal_type}')" class="bg-indigo-100 text-indigo-600 px-4 py-2 rounded-lg hover:bg-indigo-200 transition font-medium">
              üîÑ Cambiar
            </button>
          </div>
        </div>
      `).join('');
      
      // Actualizar macros
      const dayTotals = currentPlan.daily_totals?.[day] || {};
      updateMacros(dayTotals);
    }

    function updateMacros(totals) {
      document.getElementById('macro-calories').textContent = Math.round(totals.calories || 0);
      document.getElementById('macro-protein').textContent = `${Math.round(totals.protein || 0)}g`;
      document.getElementById('macro-carbs').textContent = `${Math.round(totals.carbs || 0)}g`;
      document.getElementById('macro-fat').textContent = `${Math.round(totals.fat || 0)}g`;
    }

    // ============================================================
    // WEIGHT CHECK-IN
    // ============================================================
    async function handleWeightCheckin(e) {
      e.preventDefault();
      
      const weight = parseFloat(document.getElementById('checkin-weight').value);
      
      try {
        const res = await fetch(`${API_URL}/weight/checkin`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({user_id: currentUser.id, weight})
        });
        
        const data = await res.json();
        
        if (data.success) {
          alert(`‚úÖ Peso registrado: ${weight} kg\n\nSe han a√±adido nuevas opciones a tu banco de comidas.`);
          document.getElementById('checkin-weight').value = '';
          loadDashboard();
        } else {
          alert(data.error || 'Error al registrar peso');
        }
      } catch (err) {
        alert('Error de conexi√≥n: ' + err.message);
      }
    }

    // ============================================================
    // SHOPPING LIST
    // ============================================================
    async function loadShoppingList() {
      try {
        const res = await fetch(`${API_URL}/shopping-list?user_id=${currentUser.id}`);
        const data = await res.json();
        
        const content = document.getElementById('shopping-content');
        const list = data.shopping_list;
        
        content.innerHTML = `
          <div class="grid md:grid-cols-2 gap-6">
            ${list.mercadona?.length ? `
              <div>
                <h3 class="font-bold text-lg mb-3 text-red-600">üõí Mercadona</h3>
                <ul class="space-y-2">
                  ${list.mercadona.map(item => `<li class="flex items-start gap-2"><span class="text-green-500">‚úì</span><span>${item}</span></li>`).join('')}
                </ul>
              </div>
            ` : ''}
            ${list.lidl?.length ? `
              <div>
                <h3 class="font-bold text-lg mb-3 text-blue-600">üõí Lidl</h3>
                <ul class="space-y-2">
                  ${list.lidl.map(item => `<li class="flex items-start gap-2"><span class="text-green-500">‚úì</span><span>${item}</span></li>`).join('')}
                </ul>
              </div>
            ` : ''}
            ${list.mixto?.length ? `
              <div>
                <h3 class="font-bold text-lg mb-3 text-purple-600">üõí Ambos supermercados</h3>
                <ul class="space-y-2">
                  ${list.mixto.map(item => `<li class="flex items-start gap-2"><span class="text-green-500">‚úì</span><span>${item}</span></li>`).join('')}
                </ul>
              </div>
            ` : ''}
          </div>
        `;
        
        document.getElementById('shopping-modal').classList.remove('hidden');
      } catch (err) {
        alert('Error al cargar lista: ' + err.message);
      }
    }

    function closeShoppingModal() {
      document.getElementById('shopping-modal').classList.add('hidden');
    }

    // ============================================================
    // OPTIONS MODAL (CAMBIAR COMIDA)
    // ============================================================
    let currentMealTypeToSwap = null;

    async function showOptionsModal(mealType) {
      currentMealTypeToSwap = mealType;
      
      try {
        const res = await fetch(`${API_URL}/food-bank/options?user_id=${currentUser.id}&meal_type=${mealType}`);
        const data = await res.json();
        
        const content = document.getElementById('options-content');
        
        if (!data.options?.length) {
          content.innerHTML = '<p class="text-gray-500 text-center">No hay m√°s opciones disponibles</p>';
        } else {
          content.innerHTML = data.options.map(opt => `
            <div class="border rounded-lg p-4 hover:shadow-md transition">
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <h3 class="font-bold text-lg">${opt.name}</h3>
                  <p class="text-sm text-gray-600 mt-1">${opt.ingredients}</p>
                  <div class="flex gap-3 mt-2 text-sm">
                    <span class="text-red-600">üî• ${opt.calories} kcal</span>
                    <span class="text-blue-600">ü•© ${Math.round(opt.protein)}g</span>
                    <span class="text-yellow-600">üçû ${Math.round(opt.carbs)}g</span>
                    <span class="text-purple-600">ü•ë ${Math.round(opt.fat)}g</span>
                  </div>
                  <p class="text-xs text-gray-500 mt-2">Usada ${opt.times_used || 0} veces</p>
                </div>
                <button onclick="swapMeal(${opt.id})" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition font-medium">
                  Seleccionar
                </button>
              </div>
            </div>
          `).join('');
        }
        
        document.getElementById('options-modal').classList.remove('hidden');
      } catch (err) {
        alert('Error al cargar opciones: ' + err.message);
      }
    }

    function closeOptionsModal() {
      document.getElementById('options-modal').classList.add('hidden');
      currentMealTypeToSwap = null;
    }

    async function swapMeal(recipeId) {
      if (!currentMealTypeToSwap) return;
      
      try {
        const res = await fetch(`${API_URL}/plan/swap`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            user_id: currentUser.id,
            day: selectedDay,
            meal_type: currentMealTypeToSwap,
            new_recipe_id: recipeId
          })
        });
        
        const data = await res.json();
        
        if (data.success) {
          closeOptionsModal();
          loadDashboard();
        } else {
          alert(data.error || 'Error al cambiar');
        }
      } catch (err) {
        alert('Error de conexi√≥n: ' + err.message);
      }
    }

    // ============================================================
    // INICIALIZACI√ìN
    // ============================================================
    window.addEventListener('DOMContentLoaded', () => {
      const saved = localStorage.getItem('user');
      if (saved) {
        currentUser = JSON.parse(saved);
        showDashboard();
      } else {
        showWelcome();
      }
    });
  </script>
</body>
</html>
