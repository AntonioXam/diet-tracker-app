<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Diet Tracker FIT - Tu plan semanal saludable</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', sans-serif; }
    .fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .gradient-text { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .card-hover { transition: all 0.3s ease; }
    .card-hover:hover { transform: translateY(-4px); box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
    .macro-bar { height: 8px; border-radius: 4px; background: linear-gradient(90deg, #667eea, #764ba2); }
    .day-tab.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100">
  
  <!-- Navbar -->
  <nav class="bg-white/80 backdrop-blur-md shadow-sm border-b border-gray-100 sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
      <div class="flex items-center gap-3">
        <span class="text-3xl">ğŸ¥—</span>
        <div>
          <h1 class="text-xl font-bold gradient-text">Diet Tracker FIT</h1>
          <p class="text-xs text-gray-500">Productos saludables Mercadona & Lidl</p>
        </div>
      </div>
      <div id="nav-auth" class="flex gap-3">
        <button onclick="showLogin()" class="text-gray-600 hover:text-indigo-600 font-medium px-4 py-2 rounded-lg hover:bg-gray-100 transition">Entrar</button>
        <button onclick="showRegister()" class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-5 py-2 rounded-lg font-semibold hover:shadow-lg transition transform hover:scale-105">Registrarse</button>
      </div>
      <div id="nav-user" class="hidden flex items-center gap-4">
        <div class="text-right">
          <p id="user-name" class="font-semibold text-gray-800"></p>
          <p class="text-xs text-gray-500">Usuario</p>
        </div>
        <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-500 rounded-full flex items-center justify-center text-white font-bold shadow-lg"></div>
        <button onclick="showEditProfile()" class="bg-indigo-50 text-indigo-600 hover:bg-indigo-100 px-4 py-2 rounded-xl text-sm font-semibold transition flex items-center gap-2">âš™ï¸ Editar perfil</button>
        <button onclick="logout()" class="text-red-500 hover:text-red-700 text-sm font-medium px-3 py-1 rounded-lg hover:bg-red-50 transition">Salir</button>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto px-4 py-8">
    
    <!-- Welcome Screen -->
    <div id="welcome-screen" class="text-center py-12 fade-in">
      <div class="mb-8">
        <span class="text-6xl mb-4 block">ğŸ¯</span>
        <h2 class="text-5xl font-extrabold text-gray-900 mb-4">Transforma tu alimentaciÃ³n</h2>
        <p class="text-xl text-gray-600 max-w-2xl mx-auto">Plan nutricional personalizado con productos <span class="font-semibold text-red-600">Mercadona</span> y <span class="font-semibold text-blue-600">Lidl</span>. Sistema progresivo que evoluciona contigo.</p>
      </div>
      
      <div class="flex justify-center gap-4 mb-12">
        <button onclick="showRegister()" class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-10 py-4 rounded-xl font-bold text-lg hover:shadow-2xl transition transform hover:scale-105">Comenzar gratis â†’</button>
        <button onclick="showLogin()" class="bg-white text-indigo-600 px-10 py-4 rounded-xl font-bold text-lg border-2 border-indigo-200 hover:border-indigo-400 hover:bg-indigo-50 transition">Ya tengo cuenta</button>
      </div>
      
      <!-- Features -->
      <div class="grid md:grid-cols-3 gap-6 max-w-5xl mx-auto">
        <div class="bg-white/60 backdrop-blur-sm p-8 rounded-2xl shadow-lg card-hover border border-gray-100">
          <div class="text-5xl mb-4">ğŸ“Š</div>
          <h3 class="font-bold text-xl mb-3 text-gray-800">Macros calculados</h3>
          <p class="text-gray-600 leading-relaxed">ProteÃ­nas, carbohidratos y grasas equilibrados para tu objetivo. Nada de nÃºmeros raros.</p>
        </div>
        <div class="bg-white/60 backdrop-blur-sm p-8 rounded-2xl shadow-lg card-hover border border-gray-100">
          <div class="text-5xl mb-4">ğŸ”„</div>
          <h3 class="font-bold text-xl mb-3 text-gray-800">Variedad semanal</h3>
          <p class="text-gray-600 leading-relaxed">Cada dÃ­a menÃºs diferentes. Cada semana nuevas opciones hasta tener 6 alternativas.</p>
        </div>
        <div class="bg-white/60 backdrop-blur-sm p-8 rounded-2xl shadow-lg card-hover border border-gray-100">
          <div class="text-5xl mb-4">ğŸ›’</div>
          <h3 class="font-bold text-xl mb-3 text-gray-800">Lista automÃ¡tica</h3>
          <p class="text-gray-600 leading-relaxed">Generada por supermercado. Solo copia y compra. Sin pensar.</p>
        </div>
      </div>

      <!-- Trust badges -->
      <div class="mt-12 flex justify-center gap-8 text-sm text-gray-500">
        <span class="flex items-center gap-2">âœ… 100% Gratis</span>
        <span class="flex items-center gap-2">âœ… Sin publicidad</span>
        <span class="flex items-center gap-2">âœ… Productos reales</span>
      </div>
    </div>

    <!-- Login Form -->
    <div id="login-form" class="hidden max-w-md mx-auto bg-white rounded-2xl shadow-2xl p-8 fade-in border border-gray-100">
      <div class="text-center mb-6">
        <span class="text-5xl block mb-3">ğŸ‘‹</span>
        <h2 class="text-3xl font-bold text-gray-900">Â¡Bienvenido de nuevo!</h2>
        <p class="text-gray-600 mt-2">Accede a tu plan nutricional</p>
      </div>
      <form onsubmit="handleLogin(event)" class="space-y-5">
        <div>
          <label class="block text-gray-700 font-semibold mb-2">Email</label>
          <input type="email" id="login-email" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
        </div>
        <div>
          <label class="block text-gray-700 font-semibold mb-2">ContraseÃ±a</label>
          <input type="password" id="login-password" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
        </div>
        <button type="submit" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-3 rounded-xl font-bold hover:shadow-lg transition transform hover:scale-[1.02]">Entrar</button>
      </form>
      <p class="text-center mt-6 text-gray-600">
        Â¿No tienes cuenta? <button onclick="showRegister()" class="text-indigo-600 font-bold hover:underline">RegÃ­strate gratis</button>
      </p>
    </div>

    <!-- Register Form -->
    <div id="register-form" class="hidden max-w-md mx-auto bg-white rounded-2xl shadow-2xl p-8 fade-in border border-gray-100">
      <div class="text-center mb-6">
        <span class="text-5xl block mb-3">ğŸ‰</span>
        <h2 class="text-3xl font-bold text-gray-900">Crea tu cuenta</h2>
        <p class="text-gray-600 mt-2">Empieza tu transformaciÃ³n hoy</p>
      </div>
      <form onsubmit="handleRegister(event)" class="space-y-5">
        <div>
          <label class="block text-gray-700 font-semibold mb-2">Nombre</label>
          <input type="text" id="register-name" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
        </div>
        <div>
          <label class="block text-gray-700 font-semibold mb-2">Email</label>
          <input type="email" id="register-email" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
        </div>
        <div>
          <label class="block text-gray-700 font-semibold mb-2">ContraseÃ±a</label>
          <input type="password" id="register-password" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
        </div>
        <button type="submit" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-3 rounded-xl font-bold hover:shadow-lg transition transform hover:scale-[1.02]">Crear cuenta</button>
      </form>
      <p class="text-center mt-6 text-gray-600">
        Â¿Ya tienes cuenta? <button onclick="showLogin()" class="text-indigo-600 font-bold hover:underline">Inicia sesiÃ³n</button>
      </p>
    </div>

    <!-- Onboarding Questionnaire -->
    <div id="onboarding-form" class="hidden max-w-3xl mx-auto bg-white rounded-2xl shadow-2xl p-8 fade-in border border-gray-100">
      <div class="text-center mb-8">
        <span class="text-5xl block mb-3">ğŸ“‹</span>
        <h2 class="text-3xl font-bold text-gray-900">Tu perfil nutricional</h2>
        <p class="text-gray-600 mt-2">Completa estos datos para calcular tus calorÃ­as y macros personalizados</p>
      </div>
      
      <form onsubmit="handleOnboarding(event)" class="space-y-6">
        <div class="grid md:grid-cols-2 gap-5">
          <div>
            <label class="block text-gray-700 font-semibold mb-2">ğŸ‚ Edad</label>
            <input type="number" id="ob-age" required placeholder="Ej: 30" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
          </div>
          <div>
            <label class="block text-gray-700 font-semibold mb-2">ğŸ‘¤ GÃ©nero</label>
            <select id="ob-gender" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
              <option value="male">Hombre</option>
              <option value="female">Mujer</option>
            </select>
          </div>
        </div>
        
        <div class="grid md:grid-cols-2 gap-5">
          <div>
            <label class="block text-gray-700 font-semibold mb-2">ğŸ“ Altura (cm)</label>
            <input type="number" id="ob-height" required placeholder="Ej: 175" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
          </div>
          <div>
            <label class="block text-gray-700 font-semibold mb-2">âš–ï¸ Peso actual (kg)</label>
            <input type="number" id="ob-current-weight" required step="0.1" placeholder="Ej: 80.5" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
          </div>
        </div>
        
        <div class="grid md:grid-cols-2 gap-5">
          <div>
            <label class="block text-gray-700 font-semibold mb-2">ğŸ¯ Peso objetivo (kg)</label>
            <input type="number" id="ob-goal-weight" required step="0.1" placeholder="Ej: 72" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
          </div>
          <div>
            <label class="block text-gray-700 font-semibold mb-2">ğŸ¯ Objetivo</label>
            <select id="ob-goal-type" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
              <option value="lose">ğŸ”¥ Perder grasa</option>
              <option value="maintain">âš–ï¸ Mantener peso</option>
              <option value="gain">ğŸ’ª Ganar mÃºsculo</option>
            </select>
          </div>
        </div>
        
        <div>
          <label class="block text-gray-700 font-semibold mb-2">ğŸƒ Nivel de actividad</label>
          <select id="ob-activity" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
            <option value="sedentary">ğŸª‘ Sedentario (poco o nada de ejercicio)</option>
            <option value="light">ğŸš¶ Ligero (1-3 dÃ­as/semana)</option>
            <option value="moderate">ğŸ‹ï¸ Moderado (3-5 dÃ­as/semana)</option>
            <option value="active">ğŸ”¥ Activo (6-7 dÃ­as/semana)</option>
            <option value="very_active">âš¡ Muy activo (trabajo fÃ­sico o 2x dÃ­a)</option>
          </select>
        </div>
        
        <div>
          <label class="block text-gray-700 font-semibold mb-2">ğŸ½ Comidas al dÃ­a</label>
          <select id="ob-meals" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
            <option value="3">3 comidas (desayuno, comida, cena)</option>
            <option value="4">4 comidas (con almuerzo)</option>
            <option value="5" selected>5 comidas (desayuno, almuerzo, comida, merienda, cena) â­ Recomendado</option>
          </select>
        </div>
        
        <div class="grid md:grid-cols-2 gap-5">
          <div>
            <label class="block text-gray-700 font-semibold mb-2">âš ï¸ Alergias (opcional)</label>
            <input type="text" id="ob-allergies" placeholder="Ej: gluten, lactosa..." class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
          </div>
          <div>
            <label class="block text-gray-700 font-semibold mb-2">âŒ Alimentos que no te gustan</label>
            <input type="text" id="ob-disliked" placeholder="Ej: pescado, brÃ³coli..." class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
          </div>
        </div>
        
        <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
          <p class="text-sm text-blue-800">ğŸ’¡ <strong>Nota:</strong> El cÃ¡lculo de calorÃ­as usa la fÃ³rmula Mifflin-St Jeor (la mÃ¡s precisa). Nunca bajaremos de 1200 kcal/dÃ­a por seguridad.</p>
        </div>
        
        <button type="submit" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 rounded-xl font-bold text-lg hover:shadow-2xl transition transform hover:scale-[1.02]">âœ¨ Crear mi plan personalizado</button>
      </form>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="hidden fade-in">
      
      <!-- Stats Overview -->
      <div class="grid md:grid-cols-4 gap-4 mb-8">
        <div class="bg-white/80 backdrop-blur-sm p-5 rounded-2xl shadow-lg border border-gray-100">
          <div class="flex items-center gap-3 mb-2">
            <span class="text-2xl">ğŸ”¥</span>
            <p class="text-gray-600 text-sm font-medium">CalorÃ­as/dÃ­a</p>
          </div>
          <p id="dash-calories" class="text-3xl font-extrabold gradient-text">--</p>
          <p class="text-xs text-gray-500 mt-1">Objetivo diario</p>
        </div>
        <div class="bg-white/80 backdrop-blur-sm p-5 rounded-2xl shadow-lg border border-gray-100">
          <div class="flex items-center gap-3 mb-2">
            <span class="text-2xl">âš–ï¸</span>
            <p class="text-gray-600 text-sm font-medium">Peso actual</p>
          </div>
          <p id="dash-weight" class="text-3xl font-extrabold text-green-600">-- kg</p>
          <p class="text-xs text-gray-500 mt-1">Ãšltimo registro</p>
        </div>
        <div class="bg-white/80 backdrop-blur-sm p-5 rounded-2xl shadow-lg border border-gray-100">
          <div class="flex items-center gap-3 mb-2">
            <span class="text-2xl">ğŸ“ˆ</span>
            <p class="text-gray-600 text-sm font-medium">Progreso</p>
          </div>
          <p id="dash-progress" class="text-3xl font-extrabold text-blue-600">--%</p>
          <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
            <div id="progress-bar" class="bg-gradient-to-r from-blue-500 to-indigo-600 h-2 rounded-full transition-all" style="width: 0%"></div>
          </div>
        </div>
        <div class="bg-white/80 backdrop-blur-sm p-5 rounded-2xl shadow-lg border border-gray-100">
          <div class="flex items-center gap-3 mb-2">
            <span class="text-2xl">ğŸ“…</span>
            <p class="text-gray-600 text-sm font-medium">Semana</p>
          </div>
          <p id="dash-week" class="text-3xl font-extrabold text-purple-600">#<span id="week-number">--</span></p>
          <p class="text-xs text-gray-500 mt-1">En curso</p>
        </div>
      </div>
      
      <!-- Weekly Plan -->
      <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl p-6 mb-8 border border-gray-100">
        <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
          <div>
            <h2 class="text-2xl font-bold text-gray-900">ğŸ“… Tu plan semanal</h2>
            <p class="text-gray-600 text-sm mt-1">Cada dÃ­a tiene menÃºs diferentes. Â¡Variedad asegurada!</p>
          </div>
          <button onclick="loadShoppingList()" class="bg-gradient-to-r from-green-500 to-emerald-600 text-white px-5 py-3 rounded-xl hover:shadow-lg transition flex items-center gap-2 font-semibold">
            ğŸ›’ Lista de la compra
          </button>
        </div>
        
        <!-- Day Tabs + Actions -->
        <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
          <div class="flex flex-wrap gap-2" id="day-tabs">
            <button class="day-tab active px-5 py-2.5 rounded-xl font-semibold transition" data-day="1">Lun</button>
            <button class="day-tab px-5 py-2.5 rounded-xl font-semibold bg-gray-100 text-gray-700 hover:bg-gray-200 transition" data-day="2">Mar</button>
            <button class="day-tab px-5 py-2.5 rounded-xl font-semibold bg-gray-100 text-gray-700 hover:bg-gray-200 transition" data-day="3">MiÃ©</button>
            <button class="day-tab px-5 py-2.5 rounded-xl font-semibold bg-gray-100 text-gray-700 hover:bg-gray-200 transition" data-day="4">Jue</button>
            <button class="day-tab px-5 py-2.5 rounded-xl font-semibold bg-gray-100 text-gray-700 hover:bg-gray-200 transition" data-day="5">Vie</button>
            <button class="day-tab px-5 py-2.5 rounded-xl font-semibold bg-gray-100 text-gray-700 hover:bg-gray-200 transition" data-day="6">SÃ¡b</button>
            <button class="day-tab px-5 py-2.5 rounded-xl font-semibold bg-gray-100 text-gray-700 hover:bg-gray-200 transition" data-day="7">Dom</button>
          </div>
          <div class="flex gap-2">
            <button onclick="exportPlan()" class="bg-gray-100 text-gray-700 px-4 py-2.5 rounded-xl hover:bg-gray-200 transition font-semibold text-sm flex items-center gap-2" title="Exportar plan en texto">
              ğŸ“‹ Exportar
            </button>
            <button onclick="regeneratePlan()" class="bg-orange-100 text-orange-700 px-4 py-2.5 rounded-xl hover:bg-orange-200 transition font-semibold text-sm flex items-center gap-2" title="Generar nuevo plan con otras recetas">
              ğŸ”„ Regenerar
            </button>
          </div>
        </div>
        
        <!-- Meals Container -->
        <div id="meals-container" class="space-y-4">
          <!-- Se llena dinÃ¡micamente -->
        </div>
        
        <!-- Daily Macros -->
        <div class="mt-8 pt-6 border-t-2 border-gray-100">
          <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
            <span>ğŸ“Š</span> Macros del dÃ­a seleccionado
          </h3>
          <div class="grid md:grid-cols-4 gap-4" id="daily-macros">
            <div class="bg-gradient-to-br from-indigo-50 to-purple-50 p-4 rounded-xl text-center border border-indigo-100">
              <p class="text-3xl font-extrabold gradient-text" id="macro-calories">0</p>
              <p class="text-sm text-gray-600 font-medium mt-1">ğŸ”¥ CalorÃ­as</p>
              <div class="macro-bar mt-2 w-full bg-gray-200">
                <div id="bar-calories" class="h-full rounded-full bg-gradient-to-r from-indigo-500 to-purple-600" style="width: 0%"></div>
              </div>
            </div>
            <div class="bg-gradient-to-br from-red-50 to-pink-50 p-4 rounded-xl text-center border border-red-100">
              <p class="text-3xl font-extrabold text-red-600" id="macro-protein">0g</p>
              <p class="text-sm text-gray-600 font-medium mt-1">ğŸ¥© ProteÃ­nas</p>
              <div class="macro-bar mt-2 w-full bg-gray-200">
                <div id="bar-protein" class="h-full rounded-full bg-gradient-to-r from-red-400 to-pink-600" style="width: 0%"></div>
              </div>
            </div>
            <div class="bg-gradient-to-br from-yellow-50 to-orange-50 p-4 rounded-xl text-center border border-yellow-100">
              <p class="text-3xl font-extrabold text-yellow-600" id="macro-carbs">0g</p>
              <p class="text-sm text-gray-600 font-medium mt-1">ğŸ Carbohidratos</p>
              <div class="macro-bar mt-2 w-full bg-gray-200">
                <div id="bar-carbs" class="h-full rounded-full bg-gradient-to-r from-yellow-400 to-orange-600" style="width: 0%"></div>
              </div>
            </div>
            <div class="bg-gradient-to-br from-blue-50 to-cyan-50 p-4 rounded-xl text-center border border-blue-100">
              <p class="text-3xl font-extrabold text-blue-600" id="macro-fat">0g</p>
              <p class="text-sm text-gray-600 font-medium mt-1">ğŸ¥‘ Grasas</p>
              <div class="macro-bar mt-2 w-full bg-gray-200">
                <div id="bar-fat" class="h-full rounded-full bg-gradient-to-r from-blue-400 to-cyan-600" style="width: 0%"></div>
              </div>
            </div>
          </div>
          <p class="text-xs text-gray-500 mt-4 text-center">* Los porcentajes son aproximados segÃºn tu objetivo diario</p>
        </div>
      </div>
      
      <!-- Weight Check-in -->
      <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl p-6 mb-8 border border-gray-100">
        <div class="flex items-start gap-4 mb-4">
          <span class="text-4xl">âš–ï¸</span>
          <div>
            <h2 class="text-2xl font-bold text-gray-900">Registro semanal de peso</h2>
            <p class="text-gray-600 mt-1">Pesate una vez por semana (mismo dÃ­a y hora). El sistema aÃ±adirÃ¡ automÃ¡ticamente nuevas recetas a tu banco de opciones.</p>
          </div>
        </div>
        <form onsubmit="handleWeightCheckin(event)" class="flex flex-col md:flex-row gap-4 items-end">
          <div class="flex-1 w-full">
            <label class="block text-gray-700 font-semibold mb-2">Tu peso actual (kg)</label>
            <input type="number" id="checkin-weight" required step="0.1" placeholder="Ej: 78.5" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
          </div>
          <button type="submit" class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-8 py-3 rounded-xl font-bold hover:shadow-lg transition transform hover:scale-105 whitespace-nowrap">âœ… Registrar peso</button>
        </form>
      </div>
    </div>

    <!-- Shopping List Modal -->
    <div id="shopping-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
      <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[85vh] overflow-y-auto">
        <div class="p-6 sticky top-0 bg-white border-b border-gray-100">
          <div class="flex justify-between items-center">
            <h2 class="text-2xl font-bold flex items-center gap-2">ğŸ›’ Lista de la compra</h2>
            <button onclick="closeShoppingModal()" class="text-gray-400 hover:text-gray-600 text-3xl font-light">&times;</button>
          </div>
        </div>
        <div id="shopping-content" class="p-6 space-y-6">
          <!-- Se llena dinÃ¡micamente -->
        </div>
      </div>
    </div>

    <!-- Meal Options Modal -->
    <div id="options-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
      <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[85vh] overflow-y-auto">
        <div class="p-6 sticky top-0 bg-white border-b border-gray-100">
          <div class="flex justify-between items-center">
            <h2 class="text-2xl font-bold flex items-center gap-2">ğŸ”„ Cambiar opciÃ³n</h2>
            <button onclick="closeOptionsModal()" class="text-gray-400 hover:text-gray-600 text-3xl font-light">&times;</button>
          </div>
          <p class="text-gray-600 text-sm mt-2">Selecciona una alternativa de tu banco de comidas</p>
        </div>
        <div id="options-content" class="p-6 space-y-4">
          <!-- Se llena dinÃ¡micamente -->
        </div>
      </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="edit-profile-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
      <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6 sticky top-0 bg-white border-b border-gray-100">
          <div class="flex justify-between items-center">
            <h2 class="text-2xl font-bold flex items-center gap-2">âš™ï¸ Editar perfil</h2>
            <button onclick="closeEditProfile()" class="text-gray-400 hover:text-gray-600 text-3xl font-light">&times;</button>
          </div>
          <p class="text-gray-600 text-sm mt-2">Modifica tus datos para recalcular el plan</p>
        </div>
        <form onsubmit="handleEditProfile(event)" class="p-6 space-y-5">
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-gray-700 font-semibold mb-2">ğŸ‚ Edad</label>
              <input type="number" id="edit-age" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div>
              <label class="block text-gray-700 font-semibold mb-2">ğŸ‘¤ GÃ©nero</label>
              <select id="edit-gender" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500">
                <option value="male">Hombre</option>
                <option value="female">Mujer</option>
              </select>
            </div>
          </div>
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-gray-700 font-semibold mb-2">ğŸ“ Altura (cm)</label>
              <input type="number" id="edit-height" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500">
            </div>
            <div>
              <label class="block text-gray-700 font-semibold mb-2">âš–ï¸ Peso actual (kg)</label>
              <input type="number" id="edit-current-weight" required step="0.1" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500">
            </div>
          </div>
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-gray-700 font-semibold mb-2">ğŸ¯ Peso objetivo (kg)</label>
              <input type="number" id="edit-goal-weight" required step="0.1" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500">
            </div>
            <div>
              <label class="block text-gray-700 font-semibold mb-2">ğŸ¯ Objetivo</label>
              <select id="edit-goal-type" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500">
                <option value="lose">ğŸ”¥ Perder grasa</option>
                <option value="maintain">âš–ï¸ Mantener peso</option>
                <option value="gain">ğŸ’ª Ganar mÃºsculo</option>
              </select>
            </div>
          </div>
          <div>
            <label class="block text-gray-700 font-semibold mb-2">ğŸƒ Nivel de actividad</label>
            <select id="edit-activity" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500">
              <option value="sedentary">ğŸª‘ Sedentario</option>
              <option value="light">ğŸš¶ Ligero (1-3 dÃ­as/semana)</option>
              <option value="moderate">ğŸ‹ï¸ Moderado (3-5 dÃ­as/semana)</option>
              <option value="active">ğŸ”¥ Activo (6-7 dÃ­as/semana)</option>
              <option value="very_active">âš¡ Muy activo (trabajo fÃ­sico o 2x dÃ­a)</option>
            </select>
          </div>
          <div>
            <label class="block text-gray-700 font-semibold mb-2">ğŸ½ Comidas al dÃ­a</label>
            <select id="edit-meals" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500">
              <option value="3">3 comidas (desayuno, comida, cena)</option>
              <option value="4">4 comidas (desayuno, comida, merienda, cena)</option>
              <option value="5">5 comidas (todas: desayuno, almuerzo, comida, merienda, cena)</option>
            </select>
          </div>
          <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4">
            <p class="text-sm text-yellow-800">âš ï¸ <strong>Nota:</strong> Al cambiar los datos, se recalcularÃ¡n tus calorÃ­as objetivo. El plan semanal se mantendrÃ¡ hasta que lo regeneres.</p>
          </div>
          <button type="submit" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 rounded-xl font-bold text-lg hover:shadow-2xl transition transform hover:scale-[1.02]">ğŸ’¾ Guardar cambios</button>
        </form>
      </div>
    </div>

  </main>

  <!-- Footer -->
  <footer class="bg-white/80 backdrop-blur-sm border-t border-gray-100 mt-16">
    <div class="max-w-7xl mx-auto px-4 py-8 text-center">
      <p class="text-gray-700 font-medium">ğŸ¥— <strong>Diet Tracker FIT</strong> - Planes personalizados con productos Mercadona y Lidl</p>
      <p class="text-sm text-gray-500 mt-3">Sistema progresivo: cada semana nuevas opciones hasta tener 6 alternativas por comida â€¢ CÃ¡lculos basados en fÃ³rmula Mifflin-St Jeor</p>
      <p class="text-xs text-gray-400 mt-4">Hecho con â¤ï¸ para una vida mÃ¡s saludable</p>
    </div>
  </footer>

  <script>
    // ============================================================
    // ESTADO GLOBAL
    // ============================================================
    let currentUser = null;
    let currentPlan = null;
    let selectedDay = 1;
    let targetCalories = 0;
    const API_URL = '/api';

    // ============================================================
    // NAVEGACIÃ“N
    // ============================================================
    function hideAll() {
      ['welcome-screen', 'login-form', 'register-form', 'onboarding-form', 'dashboard'].forEach(id => {
        document.getElementById(id).classList.add('hidden');
      });
    }

    function showWelcome() {
      hideAll();
      document.getElementById('welcome-screen').classList.remove('hidden');
      updateNav();
    }

    function showLogin() {
      hideAll();
      document.getElementById('login-form').classList.remove('hidden');
    }

    function showRegister() {
      hideAll();
      document.getElementById('register-form').classList.remove('hidden');
    }

    function showOnboarding() {
      hideAll();
      document.getElementById('onboarding-form').classList.remove('hidden');
    }

    function showDashboard() {
      hideAll();
      document.getElementById('dashboard').classList.remove('hidden');
      updateNav();
      loadDashboard();
    }

    function updateNav() {
      const authDiv = document.getElementById('nav-auth');
      const userDiv = document.getElementById('nav-user');
      
      if (currentUser) {
        authDiv.classList.add('hidden');
        userDiv.classList.remove('hidden');
        document.getElementById('user-name').textContent = currentUser.name;
        document.querySelector('#nav-user .rounded-full').textContent = currentUser.name.charAt(0).toUpperCase();
      } else {
        authDiv.classList.remove('hidden');
        userDiv.classList.add('hidden');
      }
    }

    // ============================================================
    // AUTENTICACIÃ“N
    // ============================================================
    async function handleRegister(e) {
      e.preventDefault();
      
      const name = document.getElementById('register-name').value;
      const email = document.getElementById('register-email').value;
      const password = document.getElementById('register-password').value;
      
      try {
        const res = await fetch(`${API_URL}/register`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({name, email, password})
        });
        
        const data = await res.json();
        
        if (data.success) {
          currentUser = {id: data.user_id, name, email};
          localStorage.setItem('user', JSON.stringify(currentUser));
          showOnboarding();
        } else {
          alert('âš ï¸ ' + (data.error || 'Error al registrar'));
        }
      } catch (err) {
        alert('âŒ Error de conexiÃ³n: ' + err.message);
      }
    }

    async function handleLogin(e) {
      e.preventDefault();
      
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      
      try {
        const res = await fetch(`${API_URL}/login`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({email, password})
        });
        
        const data = await res.json();
        
        if (data.success) {
          currentUser = {id: data.user_id, name: data.name, email};
          localStorage.setItem('user', JSON.stringify(currentUser));
          showDashboard();
        } else {
          alert('âš ï¸ ' + (data.error || 'Credenciales invÃ¡lidas'));
        }
      } catch (err) {
        alert('âŒ Error de conexiÃ³n: ' + err.message);
      }
    }

    function logout() {
      currentUser = null;
      localStorage.removeItem('user');
      showWelcome();
    }

    // ============================================================
    // ONBOARDING
    // ============================================================
    async function handleOnboarding(e) {
      e.preventDefault();
      
      const profile = {
        user_id: currentUser.id,
        age: parseInt(document.getElementById('ob-age').value),
        gender: document.getElementById('ob-gender').value,
        height: parseFloat(document.getElementById('ob-height').value),
        current_weight: parseFloat(document.getElementById('ob-current-weight').value),
        goal_weight: parseFloat(document.getElementById('ob-goal-weight').value),
        goal_type: document.getElementById('ob-goal-type').value,
        activity_level: document.getElementById('ob-activity').value,
        meals_per_day: parseInt(document.getElementById('ob-meals').value),
        allergies: document.getElementById('ob-allergies').value,
        disliked_foods: document.getElementById('ob-disliked').value
      };
      
      try {
        const res = await fetch(`${API_URL}/profile`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(profile)
        });
        
        const data = await res.json();
        
        if (data.success) {
          targetCalories = data.target_calories;
          alert(`âœ… Â¡Plan creado!\n\nğŸ”¥ CalorÃ­as objetivo: ${data.target_calories} kcal/dÃ­a\nğŸ“Š TMB: ${data.tmb} kcal\nâš¡ TDEE: ${data.tdee} kcal\n\nÂ¡Vamos a por ello!`);
          showDashboard();
        } else {
          alert('âš ï¸ ' + (data.error || 'Error al crear perfil'));
        }
      } catch (err) {
        alert('âŒ Error de conexiÃ³n: ' + err.message);
      }
    }

    // ============================================================
    // DASHBOARD
    // ============================================================
    async function loadDashboard() {
      if (!currentUser) return;
      
      try {
        const planRes = await fetch(`${API_URL}/plan/current?user_id=${currentUser.id}`);
        currentPlan = await planRes.json();
        
        const statsRes = await fetch(`${API_URL}/stats?user_id=${currentUser.id}`);
        const stats = await statsRes.json();
        
        document.getElementById('week-number').textContent = currentPlan.week || 1;
        document.getElementById('dash-weight').textContent = `${stats.current_weight || '--'} kg`;
        document.getElementById('dash-progress').textContent = `${stats.progress_percent || 0}%`;
        document.getElementById('progress-bar').style.width = `${stats.progress_percent || 0}%`;
        
        // Calcular calorÃ­as objetivo del usuario (usar promedio de la semana)
        const weekCalories = Object.values(currentPlan.daily_totals || {}).map(d => d.calories).filter(Boolean);
        targetCalories = weekCalories.length ? Math.round(weekCalories.reduce((a,b) => a+b, 0) / weekCalories.length) : 2000;
        document.getElementById('dash-calories').textContent = `${targetCalories} kcal`;
        
        document.querySelectorAll('.day-tab').forEach(tab => {
          tab.onclick = () => selectDay(parseInt(tab.dataset.day));
        });
        
        selectDay(1);
        
      } catch (err) {
        console.error('Error loading dashboard:', err);
        alert('âš ï¸ Error al cargar datos: ' + err.message);
      }
    }

    function selectDay(day) {
      selectedDay = day;
      
      document.querySelectorAll('.day-tab').forEach(tab => {
        const isSelected = parseInt(tab.dataset.day) === day;
        tab.className = `day-tab px-5 py-2.5 rounded-xl font-semibold transition ${
          isSelected ? 'active text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
        }`;
      });
      
      loadDayMeals(day);
    }

    function loadDayMeals(day) {
      const container = document.getElementById('meals-container');
      const meals = currentPlan.meals?.filter(m => m.day_of_week === day) || [];
      
      if (meals.length === 0) {
        container.innerHTML = '<div class="text-center py-12 bg-gray-50 rounded-2xl"><p class="text-gray-500 text-lg">ğŸ“­ No hay comidas registradas para este dÃ­a</p><p class="text-sm text-gray-400 mt-2">Completa tu perfil para generar el plan</p></div>';
        updateMacros({});
        return;
      }
      
      const mealIcons = {
        desayuno: {icon: 'ğŸŒ…', label: 'Desayuno', color: 'from-orange-500 to-amber-500'},
        almuerzo: {icon: 'ğŸ', label: 'Almuerzo', color: 'from-green-500 to-emerald-500'},
        comida: {icon: 'ğŸ½ï¸', label: 'Comida', color: 'from-red-500 to-rose-500'},
        merienda: {icon: 'ğŸª', label: 'Merienda', color: 'from-purple-500 to-pink-500'},
        cena: {icon: 'ğŸŒ™', label: 'Cena', color: 'from-indigo-500 to-blue-500'}
      };
      
      container.innerHTML = meals.map(meal => {
        const mealInfo = mealIcons[meal.meal_type] || {icon: 'ğŸ½ï¸', label: meal.meal_type, color: 'from-gray-500 to-gray-600'};
        return `
        <div class="bg-white border-2 border-gray-100 rounded-2xl p-5 hover:border-indigo-200 hover:shadow-lg transition-all card-hover">
          <div class="flex justify-between items-start gap-4">
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-2">
                <span class="text-2xl">${mealInfo.icon}</span>
                <span class="bg-gradient-to-r ${mealInfo.color} text-white text-xs font-bold px-3 py-1 rounded-full">${mealInfo.label}</span>
              </div>
              <h3 class="font-bold text-lg text-gray-900 mb-2">${meal.recipe_name || 'Sin nombre'}</h3>
              <p class="text-gray-600 text-sm leading-relaxed mb-3">${meal.ingredients || 'Sin ingredientes'}</p>
              <div class="flex flex-wrap gap-3">
                <span class="bg-red-50 text-red-700 px-3 py-1 rounded-lg text-sm font-semibold">ğŸ”¥ ${meal.calories || 0} kcal</span>
                <span class="bg-blue-50 text-blue-700 px-3 py-1 rounded-lg text-sm font-semibold">ğŸ¥© ${Math.round(meal.protein || 0)}g prot</span>
                <span class="bg-yellow-50 text-yellow-700 px-3 py-1 rounded-lg text-sm font-semibold">ğŸ ${Math.round(meal.carbs || 0)}g carb</span>
                <span class="bg-purple-50 text-purple-700 px-3 py-1 rounded-lg text-sm font-semibold">ğŸ¥‘ ${Math.round(meal.fat || 0)}g grasa</span>
              </div>
            </div>
            <button onclick="showOptionsModal('${meal.meal_type}')" class="bg-indigo-50 text-indigo-600 px-5 py-2.5 rounded-xl hover:bg-indigo-100 transition font-semibold whitespace-nowrap">
              ğŸ”„ Cambiar
            </button>
          </div>
        </div>
      `}).join('');
      
      const dayTotals = currentPlan.daily_totals?.[day] || {};
      updateMacros(dayTotals);
    }

    function updateMacros(totals) {
      const cals = Math.round(totals.calories || 0);
      const prot = Math.round(totals.protein || 0);
      const carbs = Math.round(totals.carbs || 0);
      const fat = Math.round(totals.fat || 0);
      
      document.getElementById('macro-calories').textContent = cals;
      document.getElementById('macro-protein').textContent = `${prot}g`;
      document.getElementById('macro-carbs').textContent = `${carbs}g`;
      document.getElementById('macro-fat').textContent = `${fat}g`;
      
      // Calcular porcentajes (aproximado)
      const maxCals = targetCalories || 2000;
      const calsPct = Math.min(100, (cals / maxCals) * 100);
      const protPct = Math.min(100, (prot / 150) * 100);
      const carbsPct = Math.min(100, (carbs / 200) * 100);
      const fatPct = Math.min(100, (fat / 70) * 100);
      
      document.getElementById('bar-calories').style.width = `${calsPct}%`;
      document.getElementById('bar-protein').style.width = `${protPct}%`;
      document.getElementById('bar-carbs').style.width = `${carbsPct}%`;
      document.getElementById('bar-fat').style.width = `${fatPct}%`;
    }

    // ============================================================
    // WEIGHT CHECK-IN
    // ============================================================
    async function handleWeightCheckin(e) {
      e.preventDefault();
      
      const weight = parseFloat(document.getElementById('checkin-weight').value);
      
      try {
        const res = await fetch(`${API_URL}/weight/checkin`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({user_id: currentUser.id, weight})
        });
        
        const data = await res.json();
        
        if (data.success) {
          alert(`âœ… Â¡Peso registrado!\n\nâš–ï¸ ${weight} kg guardado\nğŸ‰ Nuevas opciones desbloqueadas\n\nSigue asÃ­!`);
          document.getElementById('checkin-weight').value = '';
          loadDashboard();
        } else {
          alert('âš ï¸ ' + (data.error || 'Error al registrar'));
        }
      } catch (err) {
        alert('âŒ Error de conexiÃ³n: ' + err.message);
      }
    }

    // ============================================================
    // SHOPPING LIST
    // ============================================================
    async function loadShoppingList() {
      try {
        const res = await fetch(`${API_URL}/shopping-list?user_id=${currentUser.id}`);
        const data = await res.json();
        
        const content = document.getElementById('shopping-content');
        const list = data.shopping_list;
        
        let html = '<div class="grid md:grid-cols-2 gap-6">';
        
        if (list.mercadona?.length) {
          html += `
            <div class="bg-red-50 border-2 border-red-200 rounded-2xl p-5">
              <h3 class="font-bold text-lg mb-4 text-red-700 flex items-center gap-2">
                <span class="text-2xl">ğŸ›’</span> Mercadona
              </h3>
              <ul class="space-y-2">
                ${list.mercadona.map(item => `<li class="flex items-start gap-3"><span class="text-green-500 font-bold">âœ“</span><span class="text-gray-700">${item}</span></li>`).join('')}
              </ul>
            </div>
          `;
        }
        if (list.lidl?.length) {
          html += `
            <div class="bg-blue-50 border-2 border-blue-200 rounded-2xl p-5">
              <h3 class="font-bold text-lg mb-4 text-blue-700 flex items-center gap-2">
                <span class="text-2xl">ğŸ›’</span> Lidl
              </h3>
              <ul class="space-y-2">
                ${list.lidl.map(item => `<li class="flex items-start gap-3"><span class="text-green-500 font-bold">âœ“</span><span class="text-gray-700">${item}</span></li>`).join('')}
              </ul>
            </div>
          `;
        }
        if (list.mixto?.length) {
          html += `
            <div class="bg-purple-50 border-2 border-purple-200 rounded-2xl p-5 md:col-span-2">
              <h3 class="font-bold text-lg mb-4 text-purple-700 flex items-center gap-2">
                <span class="text-2xl">ğŸ›’</span> Disponible en ambos
              </h3>
              <ul class="space-y-2">
                ${list.mixto.map(item => `<li class="flex items-start gap-3"><span class="text-green-500 font-bold">âœ“</span><span class="text-gray-700">${item}</span></li>`).join('')}
              </ul>
            </div>
          `;
        }
        
        html += '</div>';
        content.innerHTML = html;
        
        document.getElementById('shopping-modal').classList.remove('hidden');
      } catch (err) {
        alert('âŒ Error: ' + err.message);
      }
    }

    function closeShoppingModal() {
      document.getElementById('shopping-modal').classList.add('hidden');
    }

    // ============================================================
    // OPTIONS MODAL
    // ============================================================
    let currentMealTypeToSwap = null;

    async function showOptionsModal(mealType) {
      currentMealTypeToSwap = mealType;
      
      try {
        const res = await fetch(`${API_URL}/food-bank/options?user_id=${currentUser.id}&meal_type=${mealType}`);
        const data = await res.json();
        
        const content = document.getElementById('options-content');
        
        if (!data.options?.length) {
          content.innerHTML = '<div class="text-center py-12"><p class="text-gray-500 text-lg">ğŸ“­ No hay mÃ¡s opciones disponibles</p><p class="text-sm text-gray-400 mt-2">Registra tu peso para desbloquear nuevas recetas</p></div>';
        } else {
          content.innerHTML = data.options.map((opt, idx) => `
            <div class="border-2 border-gray-100 rounded-2xl p-5 hover:border-indigo-200 hover:shadow-lg transition-all card-hover">
              <div class="flex justify-between items-start gap-4">
                <div class="flex-1">
                  <h3 class="font-bold text-lg text-gray-900 mb-2">${opt.name}</h3>
                  <p class="text-gray-600 text-sm mb-3">${opt.ingredients}</p>
                  <div class="flex flex-wrap gap-2">
                    <span class="bg-red-50 text-red-700 px-3 py-1 rounded-lg text-xs font-semibold">ğŸ”¥ ${opt.calories} kcal</span>
                    <span class="bg-blue-50 text-blue-700 px-3 py-1 rounded-lg text-xs font-semibold">ğŸ¥© ${Math.round(opt.protein)}g</span>
                    <span class="bg-yellow-50 text-yellow-700 px-3 py-1 rounded-lg text-xs font-semibold">ğŸ ${Math.round(opt.carbs)}g</span>
                    <span class="bg-purple-50 text-purple-700 px-3 py-1 rounded-lg text-xs font-semibold">ğŸ¥‘ ${Math.round(opt.fat)}g</span>
                  </div>
                  <p class="text-xs text-gray-400 mt-3">ğŸ“Š Usada ${opt.times_used || 0} veces</p>
                </div>
                <button onclick="swapMeal(${opt.recipe_id})" class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-5 py-2.5 rounded-xl hover:shadow-lg transition font-semibold whitespace-nowrap">
                  Seleccionar
                </button>
              </div>
            </div>
          `).join('');
        }
        
        document.getElementById('options-modal').classList.remove('hidden');
      } catch (err) {
        alert('âŒ Error: ' + err.message);
      }
    }

    function closeOptionsModal() {
      document.getElementById('options-modal').classList.add('hidden');
      currentMealTypeToSwap = null;
    }

    // ============================================================
    // REGENERAR PLAN
    // ============================================================
    async function regeneratePlan() {
      if (!confirm('âš ï¸ Â¿Seguro que quieres regenerar el plan?\n\nSe crearÃ¡n nuevas recetas aleatorias para esta semana. Tus opciones guardadas se mantendrÃ¡n.')) return;
      
      try {
        const res = await fetch(`${API_URL}/plan/regenerate`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({user_id: currentUser.id})
        });
        
        const data = await res.json();
        
        if (data.success) {
          alert('âœ… Â¡Plan regenerado!\n\nSe han seleccionado nuevas recetas para esta semana.');
          loadDashboard();
        } else {
          alert('âš ï¸ ' + (data.error || 'Error al regenerar'));
        }
      } catch (err) {
        alert('âŒ Error: ' + err.message);
      }
    }

    // ============================================================
    // EXPORTAR PLAN
    // ============================================================
    async function exportPlan() {
      try {
        const res = await fetch(`${API_URL}/plan/export?user_id=${currentUser.id}`);
        const data = await res.json();
        
        if (data.export) {
          // Copiar al portapapeles
          await navigator.clipboard.writeText(data.export);
          alert('âœ… Â¡Plan exportado!\n\nSe ha copiado al portapapeles. Puedes pegarlo en WhatsApp, notas, etc.');
        } else {
          alert('âš ï¸ ' + (data.error || 'Error al exportar'));
        }
      } catch (err) {
        alert('âŒ Error: ' + err.message);
      }
    }

    async function swapMeal(recipeId) {
      if (!currentMealTypeToSwap) return;
      
      try {
        const res = await fetch(`${API_URL}/plan/swap`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            user_id: currentUser.id,
            day: selectedDay,
            meal_type: currentMealTypeToSwap,
            new_recipe_id: recipeId
          })
        });
        
        const data = await res.json();
        
        if (data.success) {
          closeOptionsModal();
          loadDashboard();
        } else {
          alert('âš ï¸ ' + (data.error || 'Error al cambiar'));
        }
      } catch (err) {
        alert('âŒ Error: ' + err.message);
      }
    }

    // ============================================================
    // INICIALIZACIÃ“N
    // ============================================================
    window.addEventListener('DOMContentLoaded', () => {
      const saved = localStorage.getItem('user');
      if (saved) {
        currentUser = JSON.parse(saved);
        showDashboard();
      } else {
        showWelcome();
      }
    });

    // ============================================================
    // EDITAR PERFIL
    // ============================================================
    async function showEditProfile() {
      try {
        const res = await fetch(`${API_URL}/profile/get?user_id=${currentUser.id}`);
        const data = await res.json();
        
        if (data.profile) {
          const p = data.profile;
          document.getElementById('edit-age').value = p.age;
          document.getElementById('edit-gender').value = p.gender;
          document.getElementById('edit-height').value = p.height_cm;
          document.getElementById('edit-current-weight').value = p.current_weight_kg;
          document.getElementById('edit-goal-weight').value = p.goal_weight_kg;
          document.getElementById('edit-goal-type').value = p.goal_type;
          document.getElementById('edit-activity').value = p.activity_level;
          document.getElementById('edit-meals').value = p.meals_per_day;
          
          document.getElementById('edit-profile-modal').classList.remove('hidden');
        }
      } catch (err) {
        alert('âŒ Error: ' + err.message);
      }
    }

    function closeEditProfile() {
      document.getElementById('edit-profile-modal').classList.add('hidden');
    }

    async function handleEditProfile(e) {
      e.preventDefault();
      
      const updateData = {
        user_id: currentUser.id,
        age: parseInt(document.getElementById('edit-age').value),
        gender: document.getElementById('edit-gender').value,
        height: parseFloat(document.getElementById('edit-height').value),
        current_weight: parseFloat(document.getElementById('edit-current-weight').value),
        goal_weight: parseFloat(document.getElementById('edit-goal-weight').value),
        goal_type: document.getElementById('edit-goal-type').value,
        activity_level: document.getElementById('edit-activity').value,
        meals_per_day: parseInt(document.getElementById('edit-meals').value)
      };
      
      try {
        const res = await fetch(`${API_URL}/profile/update`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(updateData)
        });
        
        const data = await res.json();
        
        if (data.success) {
          if (data.recalculated) {
            alert(`âœ… Â¡Perfil actualizado!\n\nğŸ”¥ Nuevas calorÃ­as: ${data.target_calories} kcal/dÃ­a\nğŸ“Š TMB: ${data.tmb} kcal\nâš¡ TDEE: ${data.tdee} kcal`);
          } else {
            alert('âœ… Â¡Perfil actualizado!');
          }
          closeEditProfile();
          loadDashboard();
        }
      } catch (err) {
        alert('âŒ Error: ' + err.message);
      }
    }
  </script>
</body>
</html>
