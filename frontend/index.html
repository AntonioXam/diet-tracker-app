<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Diet Tracker FIT</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: { extend: { colors: { primary: { 50: '#f5f3ff', 100: '#ede9fe', 500: '#8b5cf6', 600: '#7c3aed', 700: '#6d28d9' } } } }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', sans-serif; }
    .gradient { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .gradient-text { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .glass { backdrop-filter: blur(12px); }
    .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    @media (max-width: 640px) { .hide-scroll::-webkit-scrollbar { display: none; } }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 to-indigo-100 dark:from-gray-900 dark:to-slate-900 transition-colors">

  <!-- Navbar -->
  <nav class="sticky top-0 z-40 bg-white/80 dark:bg-gray-800/80 glass shadow-md border-b border-gray-200 dark:border-gray-700">
    <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center gap-2">
        <div class="w-10 h-10 gradient rounded-xl flex items-center justify-center text-xl shadow-lg">ğŸ¥—</div>
        <div class="hidden sm:block">
          <h1 class="text-lg font-bold gradient-text">Diet Tracker FIT</h1>
          <p class="text-xs text-gray-500 dark:text-gray-400">250+ recetas</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button onclick="toggleDark()" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition text-lg">ğŸŒ™</button>
        <div id="nav-auth" class="flex gap-2">
          <button onclick="showModal('login')" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">Entrar</button>
          <button onclick="showModal('register')" class="gradient text-white px-4 py-2 rounded-lg text-sm font-semibold shadow hover:shadow-lg">Registrarse</button>
        </div>
        <div id="nav-user" class="hidden flex items-center gap-2">
          <span id="user-name" class="text-sm font-semibold text-gray-700 dark:text-gray-300 hidden sm:block"></span>
          <button onclick="showModal('edit')" class="gradient text-white px-3 py-1.5 rounded-lg text-xs font-semibold">âš™ï¸</button>
          <button onclick="logout()" class="text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 p-2 rounded-lg">ğŸšª</button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main -->
  <main class="max-w-7xl mx-auto px-4 py-6">
    
    <!-- Welcome -->
    <div id="welcome" class="text-center py-12">
      <div class="w-20 h-20 gradient rounded-3xl flex items-center justify-center text-4xl shadow-2xl mx-auto mb-6">ğŸ¯</div>
      <h2 class="text-3xl sm:text-4xl font-extrabold text-gray-900 dark:text-white mb-4">Transforma tu alimentaciÃ³n</h2>
      <p class="text-gray-600 dark:text-gray-300 mb-8 max-w-2xl mx-auto">Planes personalizados con productos Mercadona y Lidl. 250+ recetas saludables.</p>
      <div class="flex flex-col sm:flex-row justify-center gap-3">
        <button onclick="showModal('register')" class="gradient text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl">Comenzar gratis</button>
        <button onclick="showModal('login')" class="bg-white dark:bg-gray-800 text-gray-900 dark:text-white px-8 py-3 rounded-xl font-bold border-2 border-gray-200 dark:border-gray-700">Ya tengo cuenta</button>
      </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="hidden">
      <!-- Stats -->
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-6">
        <div class="bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-md border border-gray-100 dark:border-gray-700">
          <div class="flex items-center gap-2 mb-2">
            <div class="w-8 h-8 gradient rounded-lg flex items-center justify-center text-lg">ğŸ”¥</div>
            <span class="text-xs font-medium text-gray-500 dark:text-gray-400">CalorÃ­as/dÃ­a</span>
          </div>
          <p id="dash-cals" class="text-2xl font-bold gradient-text">--</p>
        </div>
        <div class="bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-md border border-gray-100 dark:border-gray-700">
          <div class="flex items-center gap-2 mb-2">
            <div class="w-8 h-8 bg-green-500 rounded-lg flex items-center justify-center text-lg">âš–ï¸</div>
            <span class="text-xs font-medium text-gray-500 dark:text-gray-400">Peso</span>
          </div>
          <p id="dash-weight" class="text-2xl font-bold text-green-600">-- kg</p>
        </div>
        <div class="bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-md border border-gray-100 dark:border-gray-700">
          <div class="flex items-center gap-2 mb-2">
            <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center text-lg">ğŸ“ˆ</div>
            <span class="text-xs font-medium text-gray-500 dark:text-gray-400">Progreso</span>
          </div>
          <p id="dash-progress" class="text-2xl font-bold text-blue-600">--%</p>
        </div>
        <div class="bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-md border border-gray-100 dark:border-gray-700">
          <div class="flex items-center gap-2 mb-2">
            <div class="w-8 h-8 bg-purple-500 rounded-lg flex items-center justify-center text-lg">ğŸ“…</div>
            <span class="text-xs font-medium text-gray-500 dark:text-gray-400">Semana</span>
          </div>
          <p id="dash-week" class="text-2xl font-bold text-purple-600">#--</p>
        </div>
      </div>

      <!-- Day Tabs -->
      <div class="flex gap-2 overflow-x-auto hide-scroll pb-2 mb-6" id="day-tabs">
        <button onclick="setDay(1)" class="day-btn active flex-shrink-0 px-4 py-2 rounded-xl font-bold text-sm gradient text-white shadow">Lun</button>
        <button onclick="setDay(2)" class="day-btn flex-shrink-0 px-4 py-2 rounded-xl font-bold text-sm bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 shadow">Mar</button>
        <button onclick="setDay(3)" class="day-btn flex-shrink-0 px-4 py-2 rounded-xl font-bold text-sm bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 shadow">MiÃ©</button>
        <button onclick="setDay(4)" class="day-btn flex-shrink-0 px-4 py-2 rounded-xl font-bold text-sm bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 shadow">Jue</button>
        <button onclick="setDay(5)" class="day-btn flex-shrink-0 px-4 py-2 rounded-xl font-bold text-sm bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 shadow">Vie</button>
        <button onclick="setDay(6)" class="day-btn flex-shrink-0 px-4 py-2 rounded-xl font-bold text-sm bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 shadow">SÃ¡b</button>
        <button onclick="setDay(7)" class="day-btn flex-shrink-0 px-4 py-2 rounded-xl font-bold text-sm bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 shadow">Dom</button>
      </div>

      <!-- Meals -->
      <div id="meals" class="space-y-3 mb-6"></div>

      <!-- Actions -->
      <div class="flex flex-wrap gap-2 mb-6">
        <button onclick="showShopping()" class="flex-1 gradient text-white px-4 py-3 rounded-xl font-bold text-sm shadow">ğŸ›’ Lista</button>
        <button onclick="exportPlan()" class="flex-1 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 px-4 py-3 rounded-xl font-bold text-sm border border-gray-200 dark:border-gray-700">ğŸ“‹ Exportar</button>
        <button onclick="regenerate()" class="flex-1 bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400 px-4 py-3 rounded-xl font-bold text-sm">ğŸ”„ Regenerar</button>
      </div>

      <!-- Weight -->
      <div class="bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-md border border-gray-100 dark:border-gray-700">
        <h3 class="font-bold text-lg text-gray-900 dark:text-white mb-3">âš–ï¸ Registro de peso</h3>
        <div class="flex gap-3">
          <input type="number" id="weight-in" step="0.1" placeholder="Tu peso (kg)" class="flex-1 px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-semibold focus:border-purple-500 focus:outline-none">
          <button onclick="checkin()" class="gradient text-white px-6 py-3 rounded-xl font-bold shadow hover:shadow-lg">Registrar</button>
        </div>
      </div>
    </div>
  </main>

  <!-- Modals -->
  <div id="modal-login" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 max-w-sm w-full shadow-2xl">
      <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4 text-center">ğŸ‘‹ Bienvenido</h3>
      <form onsubmit="login(event)" class="space-y-4">
        <input type="text" id="login-user" placeholder="Usuario" required class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-semibold focus:border-purple-500 focus:outline-none">
        <button type="submit" class="w-full gradient text-white py-3 rounded-xl font-bold shadow">Entrar</button>
      </form>
      <button onclick="hideModal('login')" class="mt-3 w-full text-gray-500 dark:text-gray-400 text-sm">Cancelar</button>
    </div>
  </div>

  <div id="modal-register" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 max-w-sm w-full shadow-2xl max-h-[90vh] overflow-y-auto">
      <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4 text-center">ğŸ¯ Crear cuenta</h3>
      <form onsubmit="register(event)" class="space-y-3">
        <input type="text" id="reg-user" placeholder="Usuario" required class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-semibold focus:border-purple-500 focus:outline-none text-sm">
        <div class="grid grid-cols-2 gap-2">
          <input type="number" id="reg-age" placeholder="Edad" required class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-semibold focus:border-purple-500 focus:outline-none text-sm">
          <select id="reg-gender" required class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-semibold focus:border-purple-500 focus:outline-none text-sm">
            <option value="">GÃ©nero</option>
            <option value="male">Hombre</option>
            <option value="female">Mujer</option>
          </select>
        </div>
        <div class="grid grid-cols-2 gap-2">
          <input type="number" id="reg-height" placeholder="Altura (cm)" required class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-semibold focus:border-purple-500 focus:outline-none text-sm">
          <input type="number" id="reg-weight" placeholder="Peso (kg)" required class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-semibold focus:border-purple-500 focus:outline-none text-sm">
        </div>
        <input type="number" id="reg-goal" placeholder="Peso objetivo (kg)" required class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-semibold focus:border-purple-500 focus:outline-none text-sm">
        <select id="reg-type" required class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-semibold focus:border-purple-500 focus:outline-none text-sm">
          <option value="">Objetivo</option>
          <option value="lose">Perder peso</option>
          <option value="maintain">Mantener</option>
          <option value="gain">Ganar masa</option>
        </select>
        <select id="reg-activity" required class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-semibold focus:border-purple-500 focus:outline-none text-sm">
          <option value="">Actividad</option>
          <option value="sedentary">Sedentario</option>
          <option value="light">Ligero (1-3 dÃ­as)</option>
          <option value="moderate">Moderado (3-5 dÃ­as)</option>
          <option value="active">Activo (6-7 dÃ­as)</option>
          <option value="very_active">Muy activo</option>
        </select>
        <select id="reg-meals" required class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-semibold focus:border-purple-500 focus:outline-none text-sm">
          <option value="">Comidas/dÃ­a</option>
          <option value="3">3 comidas</option>
          <option value="4">4 comidas</option>
          <option value="5">5 comidas</option>
        </select>
        <button type="submit" class="w-full gradient text-white py-3 rounded-xl font-bold shadow">Crear cuenta</button>
      </form>
      <button onclick="hideModal('register')" class="mt-3 w-full text-gray-500 dark:text-gray-400 text-sm">Cancelar</button>
    </div>
  </div>

  <div id="modal-edit" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 max-w-sm w-full shadow-2xl max-h-[90vh] overflow-y-auto">
      <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4 text-center">âš™ï¸ Editar perfil</h3>
      <form onsubmit="updateProfile(event)" class="space-y-3">
        <div class="grid grid-cols-2 gap-2">
          <input type="number" id="edit-age" required class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-semibold focus:border-purple-500 focus:outline-none text-sm">
          <select id="edit-gender" required class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-semibold focus:border-purple-500 focus:outline-none text-sm">
            <option value="male">Hombre</option>
            <option value="female">Mujer</option>
          </select>
        </div>
        <div class="grid grid-cols-2 gap-2">
          <input type="number" id="edit-height" required class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-semibold focus:border-purple-500 focus:outline-none text-sm">
          <input type="number" id="edit-weight" step="0.1" required class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-semibold focus:border-purple-500 focus:outline-none text-sm">
        </div>
        <input type="number" id="edit-goal" step="0.1" required class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-semibold focus:border-purple-500 focus:outline-none text-sm">
        <select id="edit-type" required class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-semibold focus:border-purple-500 focus:outline-none text-sm">
          <option value="lose">Perder peso</option>
          <option value="maintain">Mantener</option>
          <option value="gain">Ganar masa</option>
        </select>
        <select id="edit-activity" required class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-semibold focus:border-purple-500 focus:outline-none text-sm">
          <option value="sedentary">Sedentario</option>
          <option value="light">Ligero</option>
          <option value="moderate">Moderado</option>
          <option value="active">Activo</option>
          <option value="very_active">Muy activo</option>
        </select>
        <select id="edit-meals" required class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-semibold focus:border-purple-500 focus:outline-none text-sm">
          <option value="3">3 comidas</option>
          <option value="4">4 comidas</option>
          <option value="5">5 comidas</option>
        </select>
        <button type="submit" class="w-full gradient text-white py-3 rounded-xl font-bold shadow">Guardar</button>
      </form>
      <button onclick="hideModal('edit')" class="mt-3 w-full text-gray-500 dark:text-gray-400 text-sm">Cancelar</button>
    </div>
  </div>

  <div id="modal-options" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 max-w-lg w-full shadow-2xl max-h-[90vh] overflow-y-auto">
      <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4 text-center">ğŸ”„ Cambiar receta</h3>
      <div id="options-content" class="space-y-3"></div>
      <button onclick="hideModal('options')" class="mt-4 w-full bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 py-3 rounded-xl font-bold">Cerrar</button>
    </div>
  </div>

  <div id="modal-shopping" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 max-w-lg w-full shadow-2xl max-h-[90vh] overflow-y-auto">
      <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4 text-center">ğŸ›’ Lista de compra</h3>
      <div id="shopping-content" class="space-y-3"></div>
      <button onclick="hideModal('shopping')" class="mt-4 w-full bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 py-3 rounded-xl font-bold">Cerrar</button>
    </div>
  </div>

  <script>
    const API = 'https://diet-tracker-app-ten.vercel.app/api';
    let user = null, day = 1, cals = 0;

    // Dark mode
    function toggleDark() {
      document.documentElement.classList.toggle('dark');
      localStorage.setItem('dark', document.documentElement.classList.contains('dark'));
    }
    if (localStorage.getItem('dark') === 'true') document.documentElement.classList.add('dark');

    // Modals
    function showModal(id) { document.getElementById('modal-'+id).classList.remove('hidden'); }
    function hideModal(id) { document.getElementById('modal-'+id).classList.add('hidden'); }

    // Auth
    async function login(e) {
      e.preventDefault();
      const u = document.getElementById('login-user').value.trim();
      try {
        const r = await fetch(`${API}/user/get?username=${encodeURIComponent(u)}`);
        const d = await r.json();
        if (d.user) { user = d.user; localStorage.setItem('user', JSON.stringify(user)); hideModal('login'); loadDash(); }
        else alert('âŒ Usuario no encontrado');
      } catch (err) { alert('âŒ Error: ' + err.message); }
    }

    async function register(e) {
      e.preventDefault();
      const data = {
        username: document.getElementById('reg-user').value.trim(),
        age: parseInt(document.getElementById('reg-age').value),
        gender: document.getElementById('reg-gender').value,
        height: parseFloat(document.getElementById('reg-height').value),
        current_weight: parseFloat(document.getElementById('reg-weight').value),
        goal_weight: parseFloat(document.getElementById('reg-goal').value),
        goal_type: document.getElementById('reg-type').value,
        activity_level: document.getElementById('reg-activity').value,
        meals_per_day: parseInt(document.getElementById('reg-meals').value)
      };
      try {
        const r = await fetch(`${API}/user/create`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
        const d = await r.json();
        if (d.success) { user = d.user; localStorage.setItem('user', JSON.stringify(user)); alert(`âœ… Â¡Cuenta creada!\n\nğŸ”¥ ${d.target_calories} kcal/dÃ­a`); hideModal('register'); loadDash(); }
        else alert('âš ï¸ ' + (d.error || 'Error'));
      } catch (err) { alert('âŒ Error: ' + err.message); }
    }

    function logout() { localStorage.removeItem('user'); user = null; document.getElementById('nav-auth').classList.remove('hidden'); document.getElementById('nav-user').classList.add('hidden'); document.getElementById('welcome').classList.remove('hidden'); document.getElementById('dashboard').classList.add('hidden'); }

    async function loadDash() {
      document.getElementById('welcome').classList.add('hidden');
      document.getElementById('dashboard').classList.remove('hidden');
      document.getElementById('nav-auth').classList.add('hidden');
      document.getElementById('nav-user').classList.remove('hidden');
      document.getElementById('user-name').textContent = user.username;
      
      try {
        const [planR, profR] = await Promise.all([
          fetch(`${API}/plan/current?user_id=${user.id}`),
          fetch(`${API}/profile/get?user_id=${user.id}`)
        ]);
        const planD = await planR.json();
        const profD = await profR.json();
        
        if (profD.profile) {
          cals = profD.profile.target_calories || 2000;
          document.getElementById('dash-cals').textContent = `${cals} kcal`;
          document.getElementById('dash-weight').textContent = `${profD.profile.current_weight_kg} kg`;
          const start = profD.profile.starting_weight_kg || profD.profile.current_weight_kg;
          const prog = start > 0 ? Math.round(((start - profD.profile.current_weight_kg) / (start - profD.profile.goal_weight_kg)) * 100) : 0;
          document.getElementById('dash-progress').textContent = `${Math.max(0, Math.min(100, prog))}%`;
          document.getElementById('dash-week').textContent = '#' + (Math.floor(Math.abs(start - profD.profile.current_weight_kg) / 0.5) + 1);
        }
        
        if (planD.plan?.length) { setDay(1); renderDay(1); }
      } catch (err) { alert('âŒ Error: ' + err.message); }
    }

    function setDay(d) {
      day = d;
      document.querySelectorAll('.day-btn').forEach((b, i) => {
        if (i + 1 === d) { b.classList.add('gradient', 'text-white'); b.classList.remove('bg-white', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300'); }
        else { b.classList.remove('gradient', 'text-white'); b.classList.add('bg-white', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300'); }
      });
    }

    async function renderDay(d) {
      try {
        const r = await fetch(`${API}/plan/current?user_id=${user.id}`);
        const data = await r.json();
        const meals = (data.plan || []).filter(m => m.day_of_week === d);
        const container = document.getElementById('meals');
        
        if (!meals.length) { container.innerHTML = '<div class="text-center py-8 text-gray-500 dark:text-gray-400">ğŸ“­ Sin plan este dÃ­a</div>'; return; }
        
        const icons = { desayuno: ['ğŸŒ…', 'Desayuno'], almuerzo: ['ğŸ', 'Almuerzo'], comida: ['ğŸ½ï¸', 'Comida'], merienda: ['ğŸª', 'Merienda'], cena: ['ğŸŒ™', 'Cena'] };
        
        container.innerHTML = meals.map(m => {
          const icon = icons[m.meal_type] || ['ğŸ½ï¸', 'Comida'];
          return `
          <div class="bg-white dark:bg-gray-800 rounded-2xl p-4 shadow-md border border-gray-100 dark:border-gray-700 card-hover">
            <div class="flex justify-between items-start gap-3">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-xl">${icon[0]}</span>
                  <span class="gradient text-white text-xs font-bold px-3 py-1 rounded-full">${icon[1]}</span>
                </div>
                <h4 class="font-bold text-gray-900 dark:text-white mb-2">${m.recipe_name || 'Sin nombre'}</h4>
                ${m.image_url ? `<img src="${m.image_url}" class="w-full h-40 object-cover rounded-xl mb-3 shadow">` : ''}
                <p class="text-sm text-gray-600 dark:text-gray-300 mb-3">${m.ingredients || ''}</p>
                <div class="flex flex-wrap gap-2">
                  <span class="gradient text-white px-3 py-1 rounded-lg text-xs font-bold">${m.calories || 0} kcal</span>
                  <span class="bg-blue-500 text-white px-3 py-1 rounded-lg text-xs font-bold">ğŸ¥© ${Math.round(m.protein || 0)}g</span>
                  <span class="bg-yellow-500 text-white px-3 py-1 rounded-lg text-xs font-bold">ğŸ ${Math.round(m.carbs || 0)}g</span>
                  <span class="bg-purple-500 text-white px-3 py-1 rounded-lg text-xs font-bold">ğŸ¥‘ ${Math.round(m.fat || 0)}g</span>
                </div>
              </div>
              <button onclick="showOptions('${m.meal_type}')" class="gradient text-white px-4 py-2 rounded-xl font-bold text-sm shadow whitespace-nowrap">ğŸ”„</button>
            </div>
          </div>`;
        }).join('');
      } catch (err) { document.getElementById('meals').innerHTML = `<div class="text-center py-8 text-red-500">âŒ ${err.message}</div>`; }
    }

    async function checkin() {
      const w = parseFloat(document.getElementById('weight-in').value);
      if (!w) return alert('âš ï¸ Peso invÃ¡lido');
      try {
        const r = await fetch(`${API}/weight/checkin`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({user_id: user.id, weight: w}) });
        const d = await r.json();
        if (d.success) { alert(`âœ… Â¡Peso registrado!\n${d.new_recipes ? 'ğŸ‰ Nuevas recetas desbloqueadas' : ''}`); document.getElementById('weight-in').value = ''; loadDash(); }
        else alert('âš ï¸ ' + (d.error || 'Error'));
      } catch (err) { alert('âŒ Error: ' + err.message); }
    }

    async function showOptions(mealType) {
      try {
        const r = await fetch(`${API}/food-bank/options?user_id=${user.id}&meal_type=${mealType}`);
        const d = await r.json();
        const content = document.getElementById('options-content');
        if (!d.options?.length) { content.innerHTML = '<div class="text-center py-8 text-gray-500">ğŸ“­ Sin opciones disponibles</div>'; }
        else {
          content.innerHTML = d.options.map(o => `
            <div class="border border-gray-200 dark:border-gray-700 rounded-xl p-4">
              <div class="flex justify-between gap-3">
                <div class="flex-1">
                  <h4 class="font-bold text-gray-900 dark:text-white mb-1">${o.name}</h4>
                  ${o.image_url ? `<img src="${o.image_url}" class="w-full h-32 object-cover rounded-lg mb-2">` : ''}
                  <p class="text-sm text-gray-600 dark:text-gray-300 mb-2">${o.ingredients}</p>
                  <div class="flex flex-wrap gap-2">
                    <span class="gradient text-white px-2 py-1 rounded text-xs font-bold">${o.calories} kcal</span>
                    <span class="bg-blue-500 text-white px-2 py-1 rounded text-xs font-bold">ğŸ¥© ${Math.round(o.protein)}g</span>
                    <span class="bg-yellow-500 text-white px-2 py-1 rounded text-xs font-bold">ğŸ ${Math.round(o.carbs)}g</span>
                    <span class="bg-purple-500 text-white px-2 py-1 rounded text-xs font-bold">ğŸ¥‘ ${Math.round(o.fat)}g</span>
                  </div>
                </div>
                <button onclick="swap(${o.recipe_id})" class="gradient text-white px-4 py-2 rounded-xl font-bold text-sm shadow h-fit">Seleccionar</button>
              </div>
            </div>`).join('');
        }
        showModal('options');
      } catch (err) { alert('âŒ Error: ' + err.message); }
    }

    async function swap(recipeId) {
      try {
        const r = await fetch(`${API}/plan/swap`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({user_id: user.id, day: day, meal_type: currentMealType, new_recipe_id: recipeId}) });
        const d = await r.json();
        if (d.success) { hideModal('options'); renderDay(day); }
        else alert('âš ï¸ ' + (d.error || 'Error'));
      } catch (err) { alert('âŒ Error: ' + err.message); }
    }
    let currentMealType = '';

    async function showShopping() {
      try {
        const r = await fetch(`${API}/plan/shopping-list?user_id=${user.id}`);
        const d = await r.json();
        const list = d.list || {};
        let html = '';
        if (list.mercadona?.length) html += `<div class="bg-red-50 dark:bg-red-900/20 border-2 border-red-200 dark:border-red-800 rounded-xl p-4"><h4 class="font-bold text-red-700 dark:text-red-400 mb-2">ğŸ›’ Mercadona</h4><ul class="space-y-1 text-sm">${list.mercadona.map(i => `<li class="text-gray-700 dark:text-gray-300">âœ“ ${i}</li>`).join('')}</ul></div>`;
        if (list.lidl?.length) html += `<div class="bg-blue-50 dark:bg-blue-900/20 border-2 border-blue-200 dark:border-blue-800 rounded-xl p-4"><h4 class="font-bold text-blue-700 dark:text-blue-400 mb-2">ğŸ›’ Lidl</h4><ul class="space-y-1 text-sm">${list.lidl.map(i => `<li class="text-gray-700 dark:text-gray-300">âœ“ ${i}</li>`).join('')}</ul></div>`;
        if (list.mixto?.length) html += `<div class="bg-purple-50 dark:bg-purple-900/20 border-2 border-purple-200 dark:border-purple-800 rounded-xl p-4"><h4 class="font-bold text-purple-700 dark:text-purple-400 mb-2">ğŸ›’ Ambos</h4><ul class="space-y-1 text-sm">${list.mixto.map(i => `<li class="text-gray-700 dark:text-gray-300">âœ“ ${i}</li>`).join('')}</ul></div>`;
        document.getElementById('shopping-content').innerHTML = html || '<div class="text-center py-8 text-gray-500">ğŸ“­ Lista vacÃ­a</div>';
        showModal('shopping');
      } catch (err) { alert('âŒ Error: ' + err.message); }
    }

    async function regenerate() {
      if (!confirm('âš ï¸ Â¿Regenerar plan?')) return;
      try {
        const r = await fetch(`${API}/plan/regenerate`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({user_id: user.id}) });
        const d = await r.json();
        if (d.success) { alert('âœ… Â¡Plan regenerado!'); renderDay(day); }
        else alert('âš ï¸ ' + (d.error || 'Error'));
      } catch (err) { alert('âŒ Error: ' + err.message); }
    }

    async function exportPlan() {
      try {
        const r = await fetch(`${API}/plan/export?user_id=${user.id}`);
        const d = await r.json();
        if (d.export) { await navigator.clipboard.writeText(d.export); alert('âœ… Â¡Plan copiado!'); }
      } catch (err) { alert('âŒ Error: ' + err.message); }
    }

    async function updateProfile(e) {
      e.preventDefault();
      const data = {
        user_id: user.id,
        age: parseInt(document.getElementById('edit-age').value),
        gender: document.getElementById('edit-gender').value,
        height: parseFloat(document.getElementById('edit-height').value),
        current_weight: parseFloat(document.getElementById('edit-weight').value),
        goal_weight: parseFloat(document.getElementById('edit-goal').value),
        goal_type: document.getElementById('edit-type').value,
        activity_level: document.getElementById('edit-activity').value,
        meals_per_day: parseInt(document.getElementById('edit-meals').value)
      };
      try {
        const r = await fetch(`${API}/profile/update`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
        const d = await r.json();
        if (d.success) {
          user = { ...user, ...data };
          localStorage.setItem('user', JSON.stringify(user));
          alert(`âœ… Â¡Perfil actualizado!\n${d.recalculated ? `ğŸ”¥ ${d.target_calories} kcal/dÃ­a` : ''}`);
          hideModal('edit');
          loadDash();
        } else alert('âš ï¸ ' + (d.error || 'Error'));
      } catch (err) { alert('âŒ Error: ' + err.message); }
    }

    // Init
    window.addEventListener('DOMContentLoaded', () => {
      const saved = localStorage.getItem('user');
      if (saved) { user = JSON.parse(saved); loadDash(); }
    });
  </script>
</body>
</html>
